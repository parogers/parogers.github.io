(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.apdungeon=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";var RES=require("./res");var Scenery=require("./scenery");var Utils=require("./utils");var Level=require("./level");var Audio=require("./audio");function Arena(level,width,endx){this.level=level;this.startx=0;this.endx=0;if(width!==undefined&&endx!==undefined){this.startx=endx-width;this.endx=endx}this.rounds=[];this.running=[];this.round=-1;this.finishing=false;this.done=false;this.doneDelay=2}Arena.prototype.update=function(dt){if(this.done)return;if(this.finishing){if(this.doneDelay>0){this.doneDelay-=dt;return}this.done=true;return}if(this.round===-1||this.rounds[this.round].done){if(this.round<this.rounds.length-1){this.round++}else{this.finishing=true}}else{this.rounds[this.round].update(dt)}};Arena.prototype.activate=function(){};function Round(level,delay){this.level=level;this.delay=delay||0;this.spawns=[];this.running=[];this.done=false;this.activated=false}Round.prototype.update=function(dt){if(this.spawns.length>0){if(this.spawns[0].roundDelay>0){this.spawns[0].roundDelay-=dt}else{var spawn=this.spawns.shift();spawn.activate();this.running.push(spawn)}}this.done=this.spawns.length===0;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.running[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _spawn=_step.value;if(_spawn.update)_spawn.update(dt);if(!_spawn.monster.dead)this.done=false}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}};Round.prototype.addSpawn=function(spawn,delay){spawn.roundDelay=delay||0;this.spawns.push(spawn)};function Spawn(level,monster,direction,ypos){this.level=level;this.monster=monster;this.direction=direction;this.ypos=ypos}Spawn.prototype.activate=function(){this.monster.sprite.x=this.level.camera.x+this.level.camera.width/2+this.direction*(this.level.camera.width/2+4);var offset=0;var y=this.level.findClearSpace(this.monster.sprite.x,this.ypos);if(y===null){console.log("WARNING: can't spawn monster near "+this.ypos);this.monster.dead=true}else{this.monster.sprite.y=y;this.level.addThing(this.monster)}};function GateSpawn(level,monster,gate){this.level=level;this.monster=monster;this.gate=gate;this.spawned=false;this.closeDelay=.5}GateSpawn.prototype.activate=function(){this.gate.startOpening()};GateSpawn.prototype.update=function(dt){if(!this.spawned&&this.gate.isOpen()){this.spawned=true;this.level.addThing(this.monster);this.monster.sprite.x=this.gate.sprite.x+this.gate.sprite.texture.width/2;this.monster.sprite.y=this.gate.sprite.y+this.gate.sprite.texture.height}else if(this.spawned&&this.closeDelay>0){this.closeDelay-=dt;if(this.closeDelay<=0){this.gate.startClosing()}}};function DropSpawn(level,monster,x,y){this.level=level;this.monster=monster;this.xpos=x;this.ypos=y;this.done=false;this.shadow=new Scenery(Utils.getFrame(RES.MAPTILES,"shadow"));this.shadow.sprite.zpos=Level.FLOOR_POS;this.shadow.sprite.anchor.set(.5,.5);this.shadow.sprite.x=x;this.shadow.sprite.y=y;var img=this.monster.dropFrame||this.monster.frames[0];this.falling=new Scenery(img);this.timer=.5;this.fallSpeed=40}DropSpawn.prototype.activate=function(){var y=this.level.findClearSpace(this.xpos,this.ypos);if(y===null){console.log("WARNING: can't spawn monster near "+this.ypos);this.monster.dead=true;return}this.ypos=y;this.shadow.sprite.y=y;this.level.addThing(this.shadow);this.falling.sprite.zpos=Level.FRONT_POS;this.falling.sprite.x=this.xpos;this.falling.sprite.y=this.level.camera.y+4};DropSpawn.prototype.update=function(dt){if(this.done)return;if(this.timer>0){this.timer-=dt;if(this.timer<=0){this.level.addThing(this.falling);Audio.playSound(RES.DROP_SND,.25)}return}this.falling.sprite.y+=this.fallSpeed*dt;if(this.falling.sprite.y>this.ypos){this.level.removeThing(this.shadow);this.level.removeThing(this.falling);this.level.addThing(this.monster);this.monster.sprite.x=this.xpos;this.monster.sprite.y=this.ypos;this.done=true}};function WaterSpawn(level,monster,x,y){this.level=level;this.monster=monster;this.xpos=x;this.ypos=y;var img=Utils.getFrame(RES.MAPTILES,"rippling_water");this.water=new Scenery(img);this.water.sprite.anchor.set(.5,.7);this.water.sprite.x=x;this.water.sprite.y=y;this.spawnDelay=1}WaterSpawn.prototype.activate=function(){this.level.addThing(this.water)};WaterSpawn.prototype.update=function(dt){if(this.spawnDelay>0){this.spawnDelay-=dt;if(this.spawnDelay<=0){this.level.removeThing(this.water);this.level.addThing(this.monster);this.monster.sprite.x=this.xpos;this.monster.sprite.y=this.ypos}}};module.exports={Arena:Arena,Round:Round,Spawn:Spawn,WaterSpawn:WaterSpawn,DropSpawn:DropSpawn,GateSpawn:GateSpawn}},{"./audio":2,"./level":16,"./res":23,"./scenery":24,"./utils":31}],2:[function(require,module,exports){"use strict";var RES=require("./res");var enabled=true;module.exports={};module.exports.playSound=function(res,vol){if(enabled){if(vol!==undefined)sounds[res].volume=vol;sounds[res].play()}};module.exports.setEnabled=function(b){enabled=b;if(enabled)module.exports.startMusic();else module.exports.stopMusic()};module.exports.startMusic=function(){var snd=sounds[RES.GAME_MUSIC];snd.loop=true;snd.volume=.5;snd.restart();snd.fadeIn(1)};module.exports.stopMusic=function(){sounds[RES.GAME_MUSIC].pause()}},{"./res":23}],3:[function(require,module,exports){"use strict";var Render=require("./render");var Utils=require("./utils");function Tile(name,solid,wall){this.name=name;this.solid=solid;this.wall=false}function Tileset(){var wall=new Tile("wall",true,true);var floor=new Tile("floor",false,false);var water=new Tile("water",false,false);water.water=true;this.tiles={smooth_floor_m:floor,smooth_wall_m:wall,water:water};this.wall=wall}Tileset.prototype.getTile=function(name){return this.tiles[name]||this.wall};function TiledBackground(tileWidth,tileHeight,wallHeight,textures,grid){var renderTexture=PIXI.RenderTexture.create(grid[0].length*tileWidth,(grid.length-1)*tileHeight+wallHeight);var cnt=new PIXI.Container;this.solid=Utils.createGrid(grid.rows,grid.cols);for(var row=0;row<grid.length;row++){for(var col=0;col<grid[0].length;col++){var sprite=new PIXI.Sprite(textures[grid[row][col]]);sprite.anchor.set(0,1);sprite.x=col*tileWidth;sprite.y=wallHeight+row*tileHeight;cnt.addChild(sprite);this.solid[row][col]=grid[row][col]!=="smooth_floor_m"}}cnt.x=0;cnt.y=0;Render.getRenderer().render(cnt,renderTexture);this.tileset=new Tileset;this.grid=grid;this.tileWidth=tileWidth;this.tileHeight=tileHeight;this.wallHeight=wallHeight;this.sprite=new PIXI.Sprite;this.sprite.texture=renderTexture;this.sprite.x=0;this.sprite.y=0}TiledBackground.prototype.getTileAt=function(x,y){var x=x-this.sprite.x;var y=y-this.sprite.y-(this.wallHeight-this.tileHeight);var row=y/this.tileHeight|0;var col=x/this.tileWidth|0;if(this.grid[row])return this.tileset.tiles[this.grid[row][col]]||this.tileset.wall;return this.tileset.wall};TiledBackground.prototype.getHeight=function(){return this.sprite.texture.height};module.exports=TiledBackground},{"./render":22,"./utils":31}],4:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Thing=require("./thing");var GroundItem=require("./grounditem");var Audio=require("./audio");function Chest(items,options){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=items[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var item=_step.value;if(!item)throw Error("item cannot be null")}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}this.openTexture=Utils.getFrame(RES.MAPTILES,"chest_open");this.closedTexture=Utils.getFrame(RES.MAPTILES,"chest_closed");this.sprite=new PIXI.Sprite(this.closedTexture);this.sprite.anchor.set(.5,.75);this.isOpen=false;this.timer=0;this.items=items;this.options=options;this.hitbox=new Thing.Hitbox(0,0,5,5)}Chest.prototype.update=function(dt){if(this.isOpen&&this.timer>0){this.timer-=dt;if(this.timer<=0){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.items[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var item=_step2.value;var gnd=new GroundItem(item,this.sprite.x+1*Utils.randUniform(0,1),this.sprite.y+2*Utils.randUniform(.1,1));this.level.addThing(gnd);var spd=Utils.randUniform(6,12);if(this.options&&this.options.ejectX){gnd.velx=this.options.ejectX*spd}else{gnd.velx=Utils.randomChoice([-1,1])*spd}gnd.velz=-Utils.randUniform(-2,6);gnd.velh=-30*Utils.randUniform(.9,1)}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}}};Chest.prototype.handleHit=function(x,y,dmg){};Chest.prototype.handlePlayerCollision=function(player){if(!this.isOpen){this.sprite.texture=this.openTexture;this.isOpen=true;this.timer=.25;Audio.playSound(RES.CHEST_SND)}};module.exports=Chest},{"./audio":2,"./grounditem":14,"./res":23,"./thing":27,"./utils":31}],5:[function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var PRIMARY=90;var PRIMARY_ALT=65;var SWAP=88;var SPACE=32;var ARROW_UP=38;var ARROW_LEFT=37;var ARROW_RIGHT=39;var ARROW_DOWN=40;var TEST_KEY=75;var DOUBLE_PRESS_TIME=.3;var DEFAULTS=[["up",ARROW_UP],["down",ARROW_DOWN],["left",ARROW_LEFT],["right",ARROW_RIGHT],["primary",[PRIMARY,PRIMARY_ALT]],["swap",SWAP],["space",SPACE]];var controls=null;var Input=function(){function Input(name){_classCallCheck(this,Input);this.name=name;this.held=false;this.pressed=false;this.released=false;this.doublePressed=false}_createClass(Input,[{key:"press",value:function press(set){this.pressed=!this.held;this.held=set===undefined?true:set}},{key:"release",value:function release(set){this.released=!!this.held;this.held=false}}]);return Input}();function GameControls(){this.inputByKey={};this.inputs=[];this.time=0;this.lastInputPressed=null;this.lastInputPressedTime=0;this.hasTouch=false;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=DEFAULTS[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var arg=_step.value;var name=arg[0];var keys=arg[1];if(typeof keys.push!=="function"){keys=[keys]}this[name]=new Input(name);this.inputs.push(this[name]);var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=keys[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var key=_step2.value;this.inputByKey[key]=this[name]}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}GameControls.prototype.getX=function(){return this.right.held-this.left.held};GameControls.prototype.getY=function(){return this.down.held-this.up.held};GameControls.prototype.update=function(dt){this.time+=dt;var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=this.inputs[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var input=_step3.value;input.pressed=false;input.released=false;input.doublePressed=false}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}};GameControls.prototype.attachKeyboardEvents=function(){var _this=this;window.addEventListener("keydown",function(event){var input=_this.inputByKey[event.keyCode];if(input&&!input.held){if(_this.lastInputPressed===input&&_this.time-_this.lastInputPressedTime<DOUBLE_PRESS_TIME){input.doublePressed=true}_this.lastInputPressedTime=_this.time;_this.lastInputPressed=input;input.press();event.stopPropagation();event.preventDefault()}});window.addEventListener("keyup",function(event){var input=_this.inputByKey[event.keyCode];if(input){input.release();event.stopPropagation();event.preventDefault()}})};GameControls.prototype.attach=function(){this.attachKeyboardEvents()};GameControls.prototype.configureButtons=function(){};var ManualControls=function(){function ManualControls(){_classCallCheck(this,ManualControls);this.dirx=0;this.diry=0;var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=DEFAULTS[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var arg=_step4.value;var name=arg[0];this[name]=new Input(name)}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}}_createClass(ManualControls,[{key:"getX",value:function getX(){return this.dirx}},{key:"getY",value:function getY(){return this.diry}}]);return ManualControls}();module.exports={};module.exports.configure=function(view){controls=new GameControls(view);controls.attach()};module.exports.update=function(dt){controls.update(dt)};module.exports.getControls=function(){return controls};module.exports.ManualControls=ManualControls},{}],6:[function(require,module,exports){"use strict";var Gate=require("./gate");var Utils=require("./utils");var RES=require("./res");function Door(){Gate.call(this);this.frames=[Utils.getFrame(RES.MAPTILES,"door1"),Utils.getFrame(RES.MAPTILES,"door2"),Utils.getFrame(RES.MAPTILES,"door3"),Utils.getFrame(RES.MAPTILES,"door4")];this.fps=3;this.sprite.anchor.set(.5,1);this.sprite.texture=this.frames[0]}Door.prototype=Object.create(Gate.prototype);module.exports=Door},{"./gate":9,"./res":23,"./utils":31}],7:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Render=require("./render");var UI=require("./ui");var GameControls=require("./controls");function GameOverScreen(levelScreen){var _this=this;this.TRANSITION_TO_GAMEOVER=1;this.SHOWING_KILLS=2;this.SHOW_CONTINUE_TEXT=3;this.WAITING=4;this.DONE=5;this.screenHeight=80;var scale=Render.getRenderer().height/this.screenHeight;this.screenWidth=Render.getRenderer().width/scale;this.levelScreen=levelScreen;this.state=this.TRANSITION_TO_GAMEOVER;this.stage=new PIXI.Container;this.stage.scale.set(scale);this.stage.addChild(levelScreen.stage);levelScreen.stage.scale.set(levelScreen.stage.scale.x/scale);this.bg=new PIXI.Sprite(Utils.getFrame(RES.UI,"black"));this.bg.anchor.set(0,0);this.bg.scale.set(this.screenWidth/this.bg.texture.width,this.screenHeight/this.bg.texture.height);this.bg.alpha=0;this.timer=0;this.delay=.25;this.row=0;this.col=0;this.killStats=[];var names=Object.keys(levelScreen.player.kills);var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=names[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var name=_step.value;var stat=levelScreen.player.kills[name];this.killStats.push({count:stat.count,img:stat.img,name:name})}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}this.clicked=false;Render.getContainer().addEventListener("mouseup",function(evt){_this.clicked=true});Render.getContainer().addEventListener("touchend",function(evt){_this.clicked=true});this.stage.addChild(this.bg)}GameOverScreen.prototype.destroy=function(){if(this.levelScreen!==null){this.levelScreen.destroy();this.levelScreen=null}};GameOverScreen.prototype.update=function(dt){if(this.delay>0){this.delay-=dt;return}switch(this.state){case this.TRANSITION_TO_GAMEOVER:this.timer+=dt;this.bg.alpha=Math.pow(this.timer/1.25,.5);if(this.bg.alpha>1){this.bg.alpha=1;var _txt=new PIXI.Sprite(Utils.getFrame(RES.UI,"game-over-text"));_txt.anchor.set(.5,.5);_txt.x=this.screenWidth/2;_txt.y=this.screenHeight/8;this.stage.addChild(_txt);this.state=this.SHOWING_KILLS;this.delay=.75}break;case this.SHOWING_KILLS:while(this.killStats.length>0){var xpos=10+this.col*this.screenWidth/2;var ypos=30+this.row*11;var stat=this.killStats.shift();var monster=new PIXI.Sprite(stat.img);monster.anchor.set(.5,1);monster.x=xpos;monster.y=ypos;this.stage.addChild(monster);var _msg=stat.name.toUpperCase()+" *"+stat.count;var _txt=new PIXI.Sprite(UI.renderText(_msg));_txt.x=xpos+8;_txt.y=ypos;_txt.anchor.set(0,1);_txt.scale.set(.65);this.stage.addChild(_txt);this.col++;if(this.col>1){this.row++;this.col=0}}this.state=this.SHOW_CONTINUE_TEXT;this.delay=1;break;case this.SHOW_CONTINUE_TEXT:var _msg="PRESS SPACE TO PLAY AGAIN";if(GameControls.getControls().hasTouch){_msg="TAP SCREEN TO PLAY AGAIN"}var _txt=new PIXI.Sprite(UI.renderText(_msg));_txt.anchor.set(.5,.5);_txt.x=this.screenWidth/2;_txt.y=this.screenHeight-15;this.stage.addChild(_txt);this.state=this.WAITING;break;case this.WAITING:if(GameControls.getControls().space.released||this.clicked){this.state=this.DONE}break}};GameOverScreen.prototype.render=function(){Render.getRenderer().render(this.stage)};GameOverScreen.prototype.handleResize=function(){};module.exports=GameOverScreen},{"./controls":5,"./render":22,"./res":23,"./ui":30,"./utils":31}],8:[function(require,module,exports){"use strict";var TitleScreen=require("./titlescreen");var LevelScreen=require("./levelscreen");var GameOverScreen=require("./gameover");var Render=require("./render");function GameState(){var _this=this;this.LOADING=1;this.SHOW_TITLE_SCREEN=2;this.TITLE_SCREEN=3;this.PLAYING_GAME=4;this.NEXT_SCREEN=5;this.GAME_OVER=6;this.NEW_GAME=7;this.state=this.SHOW_TITLE_SCREEN;this.screen=null;this.enableTouch=false;window.addEventListener("resize",function(){var div=Render.getContainer();var width=window.innerWidth-5;var height=window.innerHeight-5;div.style.width=width;div.style.height=height;Render.getRenderer().resize(width,height);if(_this.screen&&_this.screen.handleResize){_this.screen.handleResize()}})}GameState.prototype.update=function(dt){if(this.screen){this.screen.update(dt)}switch(this.state){case this.SHOW_TITLE_SCREEN:this.screen=new TitleScreen;this.state=this.TITLE_SCREEN;break;case this.TITLE_SCREEN:if(this.screen.state===this.screen.NEW_GAME){this.screen.destroy();this.state=this.NEW_GAME;this.enableTouch=this.screen.touchClicked}break;case this.NEW_GAME:this.screen=new LevelScreen({enableTouch:this.enableTouch});this.state=this.PLAYING_GAME;break;case this.PLAYING_GAME:if(this.screen.state===this.screen.GAME_OVER){this.screen=new GameOverScreen(this.screen);this.state=this.GAME_OVER}break;case this.GAME_OVER:if(this.screen.state===this.screen.DONE){this.screen.destroy();this.state=this.NEW_GAME}break}};GameState.prototype.render=function(){if(this.screen){this.screen.render()}};GameState.prototype.handleResize=function(){Render.resize();if(this.screen&&this.screen.handleResize){this.screen.handleResize()}};module.exports=GameState},{"./gameover":7,"./levelscreen":17,"./render":22,"./titlescreen":28}],9:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Thing=require("./thing");var GameControls=require("./controls");var Audio=require("./audio");function Gate(){this.frames=[Utils.getFrame(RES.MAPTILES,"gate_wall_1"),Utils.getFrame(RES.MAPTILES,"gate_wall_2"),Utils.getFrame(RES.MAPTILES,"gate_wall_3")];this.hitbox=new Thing.Hitbox(0,0,5,5);this.sprite=new PIXI.Sprite(this.frames[0]);this.sprite.anchor.set(0,0);this.frameNum=0;this.fps=2;this.moving=0}Gate.prototype.isOpen=function(){return this.frameNum===this.frames.length-1&&this.moving===0};Gate.prototype.startOpening=function(){if(this.frameNum<this.frames.length-1){this.moving=1}};Gate.prototype.startClosing=function(){if(this.frameNum>0){this.moving=-1}};Gate.prototype.update=function(dt){if(this.moving!==0){var fnum=Math.round(2*this.frameNum);this.frameNum+=this.moving*this.fps*dt;if(this.frameNum<0){this.frameNum=0;this.moving=0}else if(this.frameNum>=this.frames.length-1){this.frameNum=this.frames.length-1;this.moving=0}if(fnum!==Math.round(2*this.frameNum)){Audio.playSound(RES.GATE_SND,.2)}}this.sprite.texture=this.frames[Math.round(this.frameNum)|0]};Gate.prototype.handleHit=function(x,y,dmg){};Gate.prototype.handlePlayerCollision=function(player){if(this.isOpen()&&this===this.level.exitDoor&&GameControls.getControls().up&&Math.abs(player.sprite.y-this.sprite.y)<5){this.level.state=this.level.FINISHED}};module.exports=Gate},{"./audio":2,"./controls":5,"./res":23,"./thing":27,"./utils":31}],10:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var TiledBackground=require("./bg");var Level=require("./level");var Door=require("./door");var Gate=require("./gate");var Arena=require("./arena");var SnakeLike=require("./snake");var Goblin=require("./goblin");var SkelWarrior=require("./skel_warrior");var Ghost=require("./ghost");var NPC=require("./npc");var Chest=require("./chest");var Item=require("./item");var GroundItem=require("./grounditem");var Utils=require("./utils");var GameControls=require("./controls");var randint=Utils.randint;var randomChoice=Utils.randomChoice;var randUniform=Utils.randUniform;var Snake=SnakeLike.Snake;var Rat=SnakeLike.Rat;var Scorpion=SnakeLike.Scorpion;function monsterEntry(klass,score,addScore){return{klass:klass,score:score,addScore:addScore}}function randomTreasures(levelNum){switch(randint(1,10)){case 1:return[Item.Table.COIN,Item.Table.COIN,Item.Table.COIN];case 2:return[Item.Table.COIN,Item.Table.COIN,Item.Table.COIN,Item.Table.COIN,Item.Table.COIN];case 3:if(levelNum<2)return[Item.Table.SMALL_BOW,Item.Table.ARROW];else return[Item.Table.LARGE_BOW];case 4:if(levelNum<2)return[Item.Table.LEATHER_ARMOUR];else return[Item.Table.STEEL_ARMOUR];case 5:return[Item.Table.SMALL_HEALTH,Item.Table.SMALL_HEALTH,Item.Table.ARROW,Item.Table.ARROW];case 6:case 7:return[Item.Table.COIN,Item.Table.COIN,Item.Table.SMALL_HEALTH];case 8:return[Item.Table.COIN,Item.Table.COIN,Item.Table.LARGE_HEALTH];case 9:return[Item.Table.LARGE_SWORD];case 10:return[Item.Table.ARROW,Item.Table.ARROW,Item.Table.ARROW,Item.Table.COIN,Item.Table.COIN]}}function chooseMonsters(budget){var monsterTable=[monsterEntry(Snake,1,1),monsterEntry(Rat,1,1),monsterEntry(Scorpion,2,1),monsterEntry(Goblin,3,2),monsterEntry(SkelWarrior,4,3),monsterEntry(Ghost,5,4)];var picks=[];while(true){var options=[];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=monsterTable[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var entry=_step.value;if(entry.score<=budget)options.push(entry)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}if(options.length===0)break;var opt=randomChoice(options);picks.push(opt.klass);budget-=opt.score}return picks}function EnterScene(door){this.IDLE=0;this.START=1;this.OPENING_DOOR=2;this.PLAYER_ENTERING=3;this.PLAYER_LOOK_LEFT=4;this.PLAYER_LOOK_RIGHT=5;this.door=door;this.sprite=null;this.state=this.IDLE;this.timer=0;this.travelTime=0}EnterScene.prototype.update=function(dt){if(this.timer>0){this.timer-=dt;return}var player=this.level.player;switch(this.state){case this.IDLE:player.sprite.x=this.door.sprite.x;player.sprite.y=this.door.sprite.y+1;player.sprite.zpos=Level.BEHIND_BACKGROUND_POS;player.controls=new GameControls.ManualControls;this.timer=.75;this.state=this.START;break;case this.START:this.door.startOpening();this.state=this.OPENING_DOOR;break;case this.OPENING_DOOR:if(this.door.isOpen()){player.sprite.zpos=undefined;this.state=this.PLAYER_ENTERING;this.timer=.4;this.travelTime=.6}break;case this.PLAYER_ENTERING:player.controls.diry=.5;this.travelTime-=dt;if(this.travelTime<=0){this.state=this.PLAYER_LOOK_LEFT;this.timer=.5;this.door.startClosing();player.controls.dirx=0;player.controls.diry=0}else if(this.travelTime<.35){player.controls.dirx=.25}break;case this.PLAYER_LOOK_LEFT:player.faceDirection(-1);this.state=this.PLAYER_LOOK_RIGHT;this.timer=1;break;case this.PLAYER_LOOK_RIGHT:player.faceDirection(1);player.controls=GameControls.getControls();this.timer=.5;this.level.removeThing(this);break}};module.exports={};module.exports.generate=function(levelNum){var length=100;var grid=Utils.createGrid(5,length);for(var row=0;row<grid.rows;row++){for(var col=0;col<grid.cols;col++){var n=Math.random();if(n<.5)grid[0][col]="brick_wall_m";else if(n<.8)grid[0][col]="mossy_wall_m";else grid[0][col]="broken_wall_m";grid[row][col]="smooth_floor_m"}}var w=randint(4,8);var pos=randint(10,grid.cols-2-w);for(var row=1;row<grid.rows;row++){for(var col=pos-randint(0,2);col<pos+w+randint(0,2);col++){grid[row][col]="water"}}var pos=0;if(levelNum===0){pos+=10}while(true){pos+=randint(5,10);if(pos>=grid.cols-12)break;var w=1;if(Math.random()<.5){w=randint(3,5)}if(pos+w>=grid.cols)w=0;var depth=randomChoice([1,1,2,2,3]);for(var col=0;col<w;col++){for(var row=0;row<depth;row++){if(row==0)grid[row][pos+col]="wall_behind";else grid[row][pos+col]="wall_behind2"}grid[depth][pos+col]="smooth_wall_m"}pos+=w}for(var row=0;row<grid.rows-1;row++){grid[row][0]="wall_behind2";grid[row][grid.cols-1]="wall_behind2"}grid[0][0]="wall_behind";grid[0][grid.cols-1]="wall_behind";grid[grid.rows-1][0]="smooth_wall_m";grid[grid.rows-1][grid.cols-1]="smooth_wall_m";var bg=new TiledBackground(RES.TILE_WIDTH,RES.TILE_HEIGHT,RES.WALL_HEIGHT,Utils.getTextures(RES.MAPTILES),grid);var level=new Level(bg);var pos=0;while(true){if(Math.random()<.6&&pos>0){var found=-1;for(var row=grid.rows-1;row>=0;row--){if(grid[row][pos]&&grid[row][pos]!=="wall_behind"&&grid[row][pos]!=="wall_behind2"&&grid[row][pos].indexOf("wall")!==-1){found=row;break}}if(found!==-1){var gate=new Gate;gate.sprite.x=pos*RES.TILE_WIDTH;gate.sprite.y=found*RES.TILE_HEIGHT+.01;level.addThing(gate)}}pos+=randint(5,15);if(pos>=grid.cols-5)break}var endx=level.getWidth()-1;var arenaWidth=level.camera.width;var budget=(levelNum+1)*6;var firstChest=null;while(endx>arenaWidth*1.75){var arena=new Arena.Arena(level,arenaWidth,endx);level.addArena(arena);var gates=[];var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=level.things[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var thing=_step2.value;if(thing instanceof Gate&&thing.sprite.x>arena.startx&&thing.sprite.x<arena.endx){gates.push(thing)}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}for(var rnum=0;rnum<randint(2,4+levelNum);rnum++){var round=new Arena.Round(randUniform(.5,1));var monsters=null;if(rnum===0&&levelNum===0&&endx===level.getWidth()-1){monsters=[];for(var n=0;n<randint(10,20);n++){monsters.push(Rat)}}else{monsters=chooseMonsters(budget)}var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=monsters[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var klass=_step3.value;var spawn=null;var ypos=randUniform(0,level.camera.height);var style=randint(1,5);if(style===1&&klass!==Ghost){var xpos=randint(arena.startx+20,arena.endx-20);spawn=new Arena.DropSpawn(level,new klass,xpos,ypos)}else if(style===2&&gates.length>0){spawn=new Arena.GateSpawn(level,new klass,randomChoice(gates))}else{var xdir=randomChoice([-1,1]);if(endx>=level.getWidth()-1)xdir=-1;spawn=new Arena.Spawn(level,new klass,xdir,ypos)}round.addSpawn(spawn,randUniform(0,1))}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}arena.rounds.push(round)}if(randint(1,10)<7){var xpos=randint(arena.startx+30,arena.endx-30);var ypos=randint(10,level.getHeight()-30);ypos=level.findClearSpace(xpos,ypos);if(ypos!==null){var treasures=randomTreasures(levelNum);var _chest=new Chest(treasures);_chest.sprite.x=xpos;_chest.sprite.y=ypos;level.addThing(_chest);firstChest=_chest}}endx-=arenaWidth*randUniform(1,1.25)|0;if(budget>3)budget--}if(levelNum===0&&firstChest){firstChest.items=[Item.Table.SMALL_BOW]}for(var n=0;n<randint(10,20);n++){var xpos=randint(level.camera.width+10,level.getWidth()-10);var ypos=randint(10,level.getHeight()-10);ypos=level.findClearSpace(xpos,ypos);if(ypos!==null){var coin=new GroundItem(Item.Table.COIN,xpos,ypos);level.addThing(coin)}}for(var n=0;n<randint(1,5);n++){var xpos=randint(level.getWidth()/2,level.getWidth()-10);var ypos=randint(10,level.getHeight()-10);ypos=level.findClearSpace(xpos,ypos);if(ypos!==null){var coin=new GroundItem(Item.Table.SMALL_HEALTH,xpos,ypos);level.addThing(coin)}}if(levelNum===0){var items=[Item.Table.COIN,Item.Table.COIN,Item.Table.COIN,Item.Table.SMALL_SWORD];var chest=new Chest(items,{ejectX:1});chest.sprite.x=60;chest.sprite.y=24;level.addThing(chest);var npc=new NPC;npc.setDialog(["TAKE THIS AND","GO FORTH!!!"]);npc.sprite.x=46;npc.sprite.y=25;level.addThing(npc);var npc=new NPC("npc3_south_1");npc.setDialog("GOOD LUCK!");npc.sprite.x=80;npc.sprite.y=40;level.addThing(npc)}var door=new Door;door.sprite.x=20;door.sprite.y=12.8;level.addThing(door);var scn=new EnterScene(door);level.addThing(scn);var door=new Door;door.sprite.x=level.getWidth()-24;door.sprite.y=12.8;level.exitDoor=door;level.addThing(door);return level};module.exports.generateEmpty=function(rows,cols,value){var grid=Utils.createGrid(rows,cols,value);var bg=new TiledBackground(RES.TILE_WIDTH,RES.TILE_HEIGHT,RES.WALL_HEIGHT,Utils.getTextures(RES.MAPTILES),grid);return new Level(bg)}},{"./arena":1,"./bg":3,"./chest":4,"./controls":5,"./door":6,"./gate":9,"./ghost":11,"./goblin":12,"./grounditem":14,"./item":15,"./level":16,"./npc":19,"./res":23,"./skel_warrior":25,"./snake":26,"./utils":31}],11:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Thing=require("./thing");var Item=require("./item");var Audio=require("./audio");var GHOST_IDLE=0;var GHOST_ATTACKING=1;var GHOST_HURT=2;var GHOST_DEAD=3;function Ghost(state){this.name="Spectre";this.frames=Utils.getFrames(RES.ENEMIES,Ghost.FRAMES);this.health=3;this.frame=0;this.facing=1;this.dead=false;this.travel=0;this.velx=0;this.vely=0;this.accel=20;this.maxSpeed=30;this.sprite=new PIXI.Container;this.sprite.alpha=.75;this.ghostSprite=new PIXI.Sprite(this.frames[0]);this.ghostSprite.anchor.set(.5,6.5/8);this.sprite.addChild(this.ghostSprite);this.knocked=0;this.knockedTimer=0;this.state=state||GHOST_ATTACKING;this.hitbox=new Thing.Hitbox(0,0,8,4)}Ghost.FRAMES=["ghost_south_1","ghost_south_2"];Ghost.prototype.getDropTable=function(){return[[Item.Table.SMALL_HEALTH,1],[Item.Table.LARGE_HEALTH,5]]};Ghost.prototype.update=function(dt){if(this.state===GHOST_ATTACKING)this.updateAttacking(dt);else if(this.state===GHOST_HURT)this.updateHurt(dt);else if(this.state===GHOST_DEAD){this.level.removeThing(this)}};Ghost.prototype.updateAttacking=function(dt){var player=this.level.player;var accelx=player.sprite.x-this.sprite.x;var accely=player.sprite.y-this.sprite.y;var mag=Math.sqrt(accelx*accelx+accely*accely);accelx=this.accel*accelx/mag;accely=this.accel*accely/mag;this.velx+=accelx*dt+10*Math.cos(this.frame)*dt;this.vely+=accely*dt+10*Math.sin(this.frame)*dt;var speed=Math.sqrt(this.velx*this.velx+this.vely*this.vely);if(speed>this.maxSpeed){this.velx=this.maxSpeed*this.velx/speed;this.vely=this.maxSpeed*this.vely/speed}this.sprite.x+=this.velx*dt;this.sprite.y+=this.vely*dt;this.frame+=4*dt;this.ghostSprite.texture=this.frames[this.frame%this.frames.length|0]};Ghost.prototype.updateHurt=function(dt){if(this.knockedTimer>0){var dx=this.knocked*dt;var tile=this.level.bg.getTileAt(this.sprite.x+dx,this.sprite.y);if(!tile.solid){this.sprite.x+=dx}this.knockedTimer-=dt}else{this.state=GHOST_ATTACKING;this.travel=0}};Ghost.prototype.handleHit=function(srcx,srcy,dmg){var player=this.level.player;if(this.state===GHOST_DEAD)return false;this.health-=1;if(this.health<=0){Audio.playSound(RES.DEAD_SND);this.state=GHOST_DEAD;this.level.handleTreasureDrop(this.getDropTable(),this.sprite.x,this.sprite.y);player.handleMonsterKilled(this);this.dead=true}else{Audio.playSound(RES.SNAKE_HURT_SND);this.knocked=Math.sign(this.sprite.x-srcx)*100;this.knockedTimer=.1;this.state=GHOST_HURT}return true};Ghost.prototype.handlePlayerCollision=function(player){player.takeDamage(4,this)};module.exports=Ghost},{"./audio":2,"./item":15,"./res":23,"./thing":27,"./utils":31}],12:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Thing=require("./thing");var Item=require("./item");var Audio=require("./audio");var GOBLIN_IDLE=0;var GOBLIN_APPROACH=1;var GOBLIN_ATTACKING=2;var GOBLIN_START_JUMP=3;var GOBLIN_JUMPING=4;var GOBLIN_HURT=5;var GOBLIN_DEAD=6;var GOBLIN_GRAVITY=200;function Goblin(state){this.name="Goblin";this.idleFrame=Utils.getFrame(RES.ENEMIES,"goblin_south_1");this.frames=Utils.getFrames(RES.ENEMIES,Goblin.FRAMES);this.speed=14;this.health=3;this.frame=0;this.facing=1;this.jumpVerSpeed=50;this.jumpHorSpeed=24;this.dead=false;this.height=0;this.jumpStartY=0;this.velh=0;this.approachDist=30;this.jumpDist=20;this.jumpTimeout=1.5;this.jumpTimer=0;this.sprite=new PIXI.Container;this.goblinSprite=new PIXI.Sprite(this.frames[0]);this.goblinSprite.anchor.set(.5,6.5/8);this.sprite.addChild(this.goblinSprite);this.waterSprite=Utils.createSplashSprite();this.waterSprite.y=-.75;this.sprite.addChild(this.waterSprite);this.knocked=0;this.knockedTimer=0;this.state=state||GOBLIN_APPROACH;this.hitbox=new Thing.Hitbox(0,-1,6,6)}Goblin.FRAMES=["goblin_south_2","goblin_south_3"];Goblin.prototype.getDropTable=function(){return[[Item.Table.COIN,8],[Item.Table.SMALL_HEALTH,6],[Item.Table.ARROW,4],[Item.Table.STEEL_ARMOUR,1],[Item.Table.LARGE_BOW,1]]};Goblin.prototype.update=function(dt){switch(this.state){case GOBLIN_ATTACKING:this.updateAttacking(dt);break;case GOBLIN_START_JUMP:this.sprite.zpos=this.sprite.y;this.height=0;this.jumpStartY=this.sprite.y;this.velh=this.jumpVerSpeed;this.waterSprite.visible=false;this.state=GOBLIN_JUMPING;break;case GOBLIN_JUMPING:this.updateJumping(dt);break;case GOBLIN_APPROACH:this.updateApproach(dt);break;case GOBLIN_HURT:this.updateHurt(dt);break;case GOBLIN_DEAD:this.level.removeThing(this);break}};Goblin.prototype.updateJumping=function(dt){this.velh-=GOBLIN_GRAVITY*dt;this.height+=this.velh*dt;if(this.height<=0){this.sprite.y=this.jumpStartY;this.state=GOBLIN_APPROACH;return}this.sprite.y=this.jumpStartY-this.height;var x=this.sprite.x+this.facing*this.jumpHorSpeed*dt;var tile=this.level.bg.getTileAt(x,this.jumpStartY);if(!tile.solid){this.sprite.x=x}};Goblin.prototype.updateAttacking=function(dt){var player=this.level.player;var dx=0,dy=0;if(player.sprite.x>this.sprite.x){dx=1.5*this.speed*dt;this.facing=1}else{dx=-1.5*this.speed*dt;this.facing=-1}this.sprite.scale.x=this.facing*Math.abs(this.sprite.scale.x);if(player.getFacing()*this.facing<0){this.state=GOBLIN_APPROACH;return}if(Math.abs(this.sprite.x-player.sprite.x)<this.jumpDist){this.state=GOBLIN_START_JUMP;return}var dist=player.sprite.y-this.sprite.y;if(Math.abs(dist)>5){dy=dt*20*Math.sign(dist)}var tile=this.level.bg.getTileAt(this.sprite.x+dx,this.sprite.y);if(!tile.solid){this.sprite.x+=dx;this.waterSprite.visible=tile.water}var tile2=this.level.bg.getTileAt(this.sprite.x,this.sprite.y+dy);if(!tile2.solid){if(tile.solid)this.sprite.y+=3*dy;else{this.sprite.y+=dy;this.waterSprite.visible=tile2.water}}this.frame+=4*dt;this.goblinSprite.texture=this.frames[this.frame%this.frames.length|0]};Goblin.prototype.updateApproach=function(dt){var player=this.level.player;var targetx=0;if(this.sprite.x<player.sprite.x){targetx=player.sprite.x-this.approachDist;this.facing=1}else if(this.sprite.x>player.sprite.x){targetx=player.sprite.x+this.approachDist;this.facing=-1}this.sprite.scale.x=this.facing*Math.abs(this.sprite.scale.x);if(player.getFacing()*this.facing>0){this.state=GOBLIN_ATTACKING;return}this.jumpTimer+=dt;if(this.jumpTimer>this.jumpTimeout){this.jumpTimer=0;this.state=GOBLIN_START_JUMP;return}var dx=0;var dy=0;targetx+=15*Math.cos(this.frame/4);if(Math.abs(this.sprite.x-targetx)>2){dx=this.speed*dt*Math.sign(targetx-this.sprite.x)}var dist=player.sprite.y+50*Math.sin(this.frame/2)-this.sprite.y;if(Math.abs(dist)>2){dy=dt*30*Math.sign(dist)}var tile=this.level.bg.getTileAt(this.sprite.x+dx,this.sprite.y+dy);if(!tile.solid){this.sprite.x+=dx;this.sprite.y+=dy;this.waterSprite.visible=tile.water}this.frame+=4*dt;this.goblinSprite.texture=this.frames[this.frame%this.frames.length|0]};Goblin.prototype.updateHurt=function(dt){if(this.knockedTimer>0){var dx=this.knocked*dt;var tile=this.level.bg.getTileAt(this.sprite.x+dx,this.sprite.y);if(!tile.solid){this.sprite.x+=dx}this.knockedTimer-=dt}else{this.state=GOBLIN_APPROACH;this.jumpTimeout*=.5}};Goblin.prototype.handleHit=function(srcx,srcy,dmg){var player=this.level.player;if(this.state===GOBLIN_DEAD)return false;this.health-=1;if(this.health<=0){Audio.playSound(RES.DEAD_SND);this.state=GOBLIN_DEAD;this.level.handleTreasureDrop(this.getDropTable(),this.sprite.x,this.sprite.y);player.handleMonsterKilled(this);this.dead=true}else{Audio.playSound(RES.SNAKE_HURT_SND);this.knocked=Math.sign(this.sprite.x-srcx)*60;this.knockedTimer=.1;this.state=GOBLIN_HURT}var tile=this.level.bg.getTileAt(this.sprite.x,this.sprite.y);if(!tile.water){this.level.createBloodSpatter(this.sprite.x,this.sprite.y-1)}return true};Goblin.prototype.handlePlayerCollision=function(player){player.takeDamage(2,this)};module.exports=Goblin},{"./audio":2,"./item":15,"./res":23,"./thing":27,"./utils":31}],13:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Audio=require("./audio");function GoMarker(screen){this.screen=screen;this.frames=[Utils.getFrame(RES.UI,"go1"),Utils.getFrame(RES.UI,"go2")];this.sprite=new PIXI.Sprite(this.frames[0]);this.sprite.anchor.set(1,0);this.timer=0;this.dings=3;this.frameNum=0;this.done=true;this.sprite.visible=false}GoMarker.prototype.show=function(){this.done=false;this.timer=0;this.dings=3;this.frameNum=0;this.sprite.visible=true;this.sprite.texture=this.frames[0]};GoMarker.prototype.hide=function(){this.done=true;this.sprite.visible=false};GoMarker.prototype.update=function(dt){var level=this.screen.level;if(!this.sprite.visible){if(level.state===level.SHOWING_GO){this.show()}return}if(this.done){if(level.state!==level.SHOWING_GO){this.hide()}return}var next=this.timer+dt;if(this.timer<.3&&next>=.3){if(this.dings-- >0)Audio.playSound(RES.GO_SND);else this.done=true;this.frameNum=1}else if(this.timer<1&&next>=1){this.frameNum=0;next=0}this.timer=next;this.sprite.texture=this.frames[this.frameNum]};GoMarker.prototype.handleHit=function(x,y,dmg){};GoMarker.prototype.handlePlayerCollision=function(player){};module.exports=GoMarker},{"./audio":2,"./res":23,"./utils":31}],14:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Thing=require("./thing");var ITEM_GRAVITY=120;function GroundItem(item,x,y){var img=Utils.getFrame(RES.GROUND_ITEMS,item.image);this.sprite=new PIXI.Sprite(img);this.sprite.anchor.set(.5,.6);this.height=0;this.sprite.x=x;this.sprite.y=y;this.ypos=y;this.item=item;this.sprite.zpos=y;this.velx=0;this.velz=0;this.velh=0;this.bouncy=.5;this.hitbox=new Thing.Hitbox(0,0,5,5)}GroundItem.prototype.update=function(dt){if(this.velh!==0){if(this.velz!==0){var dz=this.velz*dt;var tile=this.level.bg.getTileAt(this.sprite.x,this.ypos+dz);if(tile.solid)this.velz=0;else{this.ypos+=dz;this.sprite.zpos+=dz}}var dx=this.velx*dt;var tile=this.level.bg.getTileAt(this.sprite.x+dx,this.ypos);if(tile.solid){this.velx*=-1}else{this.sprite.x+=dx}this.velh+=ITEM_GRAVITY*dt;this.height-=this.velh*dt;if(this.height<=0){if(this.velh<10){this.velh=0}else{this.velh*=-this.bouncy;this.height=0}}this.sprite.y=this.ypos-this.height}};GroundItem.prototype.handlePlayerCollision=function(player){if(this.height<3&&this.velh>=0){if(this.item&&player.handleTakeItem(this.item)){this.level.removeThing(this)}}};module.exports=GroundItem},{"./res":23,"./thing":27,"./utils":31}],15:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");function Item(image,type,quality){this.image=image;this.type=type;this.quality=quality}Item.prototype.isBetter=function(other){return this.quality>other.quality};Item.prototype.isArmour=function(){return this.type===Item.ARMOUR};Item.prototype.isSword=function(){return this.type===Item.SWORD};Item.prototype.isBow=function(){return this.type===Item.BOW};Item.OTHER=0;Item.SWORD=1;Item.BOW=2;Item.ARMOUR=3;Item.HEALTH=4;Item.Table={NO_ARMOUR:new Item("helmet3",Item.ARMOUR,0),LEATHER_ARMOUR:new Item("helmet1",Item.ARMOUR,1),STEEL_ARMOUR:new Item("helmet2",Item.ARMOUR,2),COIN:new Item("coin",Item.OTHER,0),SMALL_HEALTH:new Item("small_health",Item.HEALTH,0),LARGE_HEALTH:new Item("large_health",Item.HEALTH,1),SMALL_BOW:new Item("bow1",Item.BOW,1),LARGE_BOW:new Item("bow2",Item.BOW,2),NO_BOW:new Item("bow3",Item.BOW,3),ARROW:new Item("arrow1",Item.OTHER,0),NO_SWORD:new Item("sword4",Item.SWORD,0),SMALL_SWORD:new Item("sword1",Item.SWORD,1),LARGE_SWORD:new Item("sword2",Item.SWORD,2),MAGIC_SWORD:new Item("sword3",Item.SWORD,3),NONE:new Item(null,Item.OTHER,0)};module.exports=Item},{"./res":23,"./utils":31}],16:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Render=require("./render");var LevelGenerator=require("./genlevel");var GroundItem=require("./grounditem");function Camera(w,h){this.x=0;this.y=0;this.width=w;this.height=h}function compareDepth(s1,s2){var z1=s1.zpos||s1.y;var z2=s2.zpos||s2.y;return(z1>z2)-(z2>z1)}function Level(bg){this.ACTIVE_ARENA=1;this.SHOWING_GO=2;this.NEXT_ARENA=3;this.EXIT_OPEN=4;this.FINISHED=5;this.camera=new Camera(Level.CAMERA_WIDTH,Level.CAMERA_HEIGHT);this.player=null;this.state=this.NEXT_ARENA;this.bg=bg;this.bg.zpos=Level.BACKGROUND_POS;this.things=[];this.stage=new PIXI.Container;this.stage.addChild(this.bg.sprite);this.arenas=[];this.arenaNum=0;this.smoothTracking=true;this.exitDoor=null}Level.prototype.destroy=function(){if(this.stage){this.removeThing(this.player);this.stage.destroy({children:true});this.stage=null;this.things=null;this.player=null}};Level.prototype.getWidth=function(){return this.bg.sprite.width};Level.prototype.getHeight=function(){return this.bg.sprite.height};Level.prototype.findClearSpace=function(x,y){var offset=0;while(true){var north=this.bg.getTileAt(x,y+offset);var south=this.bg.getTileAt(x,y-offset);if(!north.solid){return y+offset}if(!south.solid){return y-offset}if(y+offset>this.getHeight()&&y-offset<0){return null}offset+=RES.TILE_HEIGHT}};Level.prototype.addArena=function(arena){this.arenas.push(arena);this.arenas.sort(function(a1,a2){return(a1.endx>a2.endx)-(a2.endx>a1.endx)})};Level.prototype.update=function(dt){var arena=this.arenas[this.arenaNum];switch(this.state){case this.ACTIVE_ARENA:if(arena.done){if(this.arenaNum<this.arenas.length-1){this.arenaNum++;this.state=this.SHOWING_GO}else{this.state=this.EXIT_OPEN;if(this.exitDoor)this.exitDoor.startOpening()}}else{arena.update(dt)}break;case this.SHOWING_GO:if(this.player.sprite.x>this.camera.x+this.camera.width*.8){this.state=this.NEXT_ARENA;this.smoothTracking=true}break;case this.NEXT_ARENA:var xpos=this.player.sprite.x-this.camera.width/2;xpos=Math.max(xpos,0);xpos=Math.min(xpos,this.bg.sprite.width-this.camera.width);if(this.smoothTracking){var dirx=Math.sign(xpos-this.camera.x);this.camera.x+=dt*1.25*this.player.maxSpeed*dirx;if(dirx!=Math.sign(xpos-this.camera.x)){this.smoothTracking=false}}else{this.camera.x=xpos}if(arena&&this.camera.x+this.camera.width>=arena.endx){this.camera.x=arena.endx-this.camera.width;arena.activate();this.state=this.ACTIVE_ARENA}break;case this.EXIT_OPEN:break}this.stage.children.sort(compareDepth);this.stage.x=-this.camera.x;this.stage.y=-this.camera.y;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.things[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var thing=_step.value;if(thing.update)thing.update(dt)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}};Level.prototype.checkHit=function(x,y,hitbox,ignore){var xp=x+hitbox.x,yp=y+hitbox.y;var w=hitbox.w,h=hitbox.h;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.things[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var thing=_step2.value;if(thing!==ignore&&thing.sprite&&thing.hitbox&&thing.hitbox!==hitbox&&Math.abs(xp-thing.sprite.x-thing.hitbox.x)<(w+thing.hitbox.w)/2&&Math.abs(yp-thing.sprite.y-thing.hitbox.y)<(h+thing.hitbox.h)/2){return thing}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}return null};Level.prototype.forEachThingHit=function(x,y,hitbox,ignore,callback){var xp=x+hitbox.x;var yp=y+hitbox.y;var w=hitbox.w;var h=hitbox.h;var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=this.things[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var thing=_step3.value;if(thing!==ignore&&thing.sprite&&thing.hitbox&&thing.hitbox!==hitbox&&Math.abs(xp-thing.sprite.x-thing.hitbox.x)<(w+thing.hitbox.w)/2&&Math.abs(yp-thing.sprite.y-thing.hitbox.y)<(h+thing.hitbox.h)/2){callback(thing)}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}};Level.prototype.checkSolidAt=function(x,y,width){var left=this.bg.getTileAt(x-width/2,y);var right=this.bg.getTileAt(x+width/2,y);return left.solid||right.solid};Level.prototype.addThing=function(thing){thing.level=this;this.things.push(thing);if(thing.sprite){this.stage.addChild(thing.sprite)}};Level.prototype.removeThing=function(thing){var i=this.things.indexOf(thing);if(i>=0){this.things[i]=this.things[this.things.length-1];this.things.pop();thing.level=null}if(thing.sprite&&thing.sprite.parent){thing.sprite.parent.removeChild(thing.sprite)}};Level.prototype.handleTreasureDrop=function(table,x,y){var total=0;var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=table[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var entry=_step4.value;total+=entry[1]}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}var pick=null;var num=Utils.randint(0,total);var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=table[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var _entry=_step5.value;num-=_entry[1];if(num<=0){pick=_entry[0];break}}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return()}}finally{if(_didIteratorError5){throw _iteratorError5}}}if(pick!==null){var gnd=new GroundItem(pick,x,y);gnd.velx=10*(x>this.camera.x?-1:1);gnd.velh=-40;this.addThing(gnd)}};Level.prototype.createBloodSpatter=function(x,y,imgs){var txt=Utils.randomChoice(imgs||["blood1","blood2","blood3"]);var sprite=new PIXI.Sprite(Utils.getFrame(RES.MAPTILES,txt));sprite.zpos=Level.FLOOR_POS;sprite.anchor.set(.5,.5);sprite.x=x;sprite.y=y;this.stage.addChild(sprite);return sprite};Level.BEHIND_BACKGROUND_POS=-1;Level.BACKGROUND_POS=0;Level.FLOOR_POS=1;Level.FRONT_POS=1e4;Level.CAMERA_WIDTH=100;Level.CAMERA_HEIGHT=60;module.exports=Level},{"./genlevel":10,"./grounditem":14,"./render":22,"./res":23,"./utils":31}],17:[function(require,module,exports){"use strict";var Render=require("./render");var UI=require("./ui");var LevelGenerator=require("./genlevel");var GoMarker=require("./gomarker");var Player=require("./player");var Level=require("./level");var Utils=require("./utils");var GameControls=require("./controls");var Audio=require("./audio");var TouchUI=require("./touchui");function LevelScreen(opts){this.NEW_GAME=1;this.PLAYING=2;this.NEXT_LEVEL=3;this.GAME_OVER=4;this.enableTouch=opts.enableTouch||false;this.levelNum=0;this.level=null;this.state=this.NEW_GAME;this.stage=new PIXI.Container;this.goMarker=new GoMarker(this);this.gameUI=new UI.GameUI;this.stage.addChild(this.goMarker.sprite);this.stage.addChild(this.gameUI.container);if(this.enableTouch){this.touchUI=new TouchUI;this.stage.addChild(this.touchUI.container)}}LevelScreen.prototype.destroy=function(){if(this.gameUI){this.gameUI.destroy();this.level.destroy();this.gameUI=null;this.level=null}if(this.touchUI){this.touchUI.destroy();this.touchUI=null}};LevelScreen.getAspectRatio=function(){return Level.CAMERA_WIDTH/Level.CAMERA_HEIGHT};LevelScreen.prototype.update=function(dt){switch(this.state){case this.NEW_GAME:this.player=new Player(GameControls.getControls());this.player.sprite.x=0;this.player.sprite.y=0;this.levelNum=0;var level=LevelGenerator.generate(this.levelNum);this.setLevel(level);this.state=this.PLAYING;Audio.startMusic();break;case this.PLAYING:if(this.level.state===this.level.FINISHED){var _level=LevelGenerator.generate(++this.levelNum);this.setLevel(_level)}else if(this.player.dead){Audio.stopMusic();this.state=this.GAME_OVER}else{if(this.level)this.level.update(dt);this.gameUI.update(dt);this.goMarker.update(dt)}break;case this.NEXT_LEVEL:break;case this.GAME_OVER:break}};LevelScreen.prototype.render=function(){if(this.level){Render.getRenderer().render(this.stage)}};LevelScreen.prototype.setLevel=function(level){if(this.level){this.stage.removeChild(this.level.stage);this.level.destroy();this.level=null}if(!level)return;this.stage.addChildAt(level.stage,0);this.level=level;this.gameUI.setPlayer(this.player);this.gameUI.container.position.set(0,level.getHeight());this.gameUI.doLayout(level.camera.width,level.camera.height-level.getHeight());if(this.touchUI){this.touchUI.doLayout(level.camera.width,level.getHeight())}this.goMarker.sprite.position.set(level.camera.width-1,2);this.level.player=this.player;this.level.addThing(this.player);this.level.update(0);this.gameUI.update(0);this.handleResize()};LevelScreen.prototype.handleResize=function(){if(this.level){var scale=Math.min(Render.getRenderer().width/this.level.camera.width,Render.getRenderer().height/this.level.camera.height);this.stage.scale.set(scale)}};module.exports=LevelScreen},{"./audio":2,"./controls":5,"./genlevel":10,"./gomarker":13,"./level":16,"./player":20,"./render":22,"./touchui":29,"./ui":30,"./utils":31}],18:[function(require,module,exports){"use strict";var RES=require("./res");var Render=require("./render");var ProgressBar=require("./progress");var GameControls=require("./controls");var LevelScreen=require("./levelscreen");var GameState=require("./gamestate");var Utils=require("./utils");var gamestate=null;var stage=null;var progress=null;var lastCheck=0;var fps=0;var lastTime=null;function gameLoop(){var now=(new Date).getTime()/1e3;var dt=0;if(lastTime!==null){dt=Math.min(1/30,now-lastTime)}lastTime=now;fps++;if(now-lastCheck>=2){lastCheck=now;fps=0}gamestate.update(dt);GameControls.update(dt);gamestate.render();requestAnimationFrame(gameLoop)}function graphicsLoaded(){sounds.whenLoaded=audioLoaded;sounds.onFailed=function(source){console.log("Failed to load audio file: "+source)};progress.setText("LOADING AUDIO...");sounds.onProgress=function(percent){progress.update(percent/100);requestAnimationFrame(function(){Render.getRenderer().render(stage)})};sounds.load([RES.ATTACK_SWORD_SND,RES.SNAKE_HURT_SND,RES.DEAD_SND,RES.ARROW_DING_SND,RES.SPLASH_SND,RES.GO_SND,RES.HIT_SND,RES.COIN_SND,RES.GATE_SND,RES.DROP_SND,RES.POWERUP1_SND,RES.POWERUP2_SND,RES.POWERUP3_SND,RES.POWERUP4_SND,RES.CHEST_SND,RES.GAME_MUSIC])}function audioLoaded(){setup()}function setup(){for(name in PIXI.loader.resources){var err=PIXI.loader.resources[name].error;if(err){console.log("Failed to load image: "+name+" ("+err+")")}}stage.children=[];requestAnimationFrame(gameLoop)}module.exports={};module.exports.start=function(elementName){var div=document.getElementById(elementName);div.focus();Render.configure(div,LevelScreen.getAspectRatio());stage=new PIXI.Container;progress=new ProgressBar(200,20,"LOADING IMAGES...");progress.sprite.x=100;progress.sprite.y=100;stage.addChild(progress.sprite);GameControls.configure();gamestate=new GameState;function progresscb(loader,resource){console.log("loading: "+resource.url+" ("+(loader.progress|0)+"%)");progress.update(loader.progress/100);requestAnimationFrame(function(){Render.getRenderer().render(stage)})}var now=(new Date).getTime();PIXI.loader.defaultQueryString="nocache="+now;PIXI.loader.add(RES.MALE_MELEE).add(RES.FEMALE_MELEE).add(RES.NPC_TILESET).add(RES.MAPTILES).add(RES.ENEMIES).add(RES.WEAPONS).add(RES.GROUND_ITEMS).add(RES.UI).on("progress",progresscb).load(graphicsLoaded)};module.exports.resize=function(){gamestate.handleResize()};module.exports.getGamestate=function(){return gamestate}},{"./controls":5,"./gamestate":8,"./levelscreen":17,"./progress":21,"./render":22,"./res":23,"./utils":31}],19:[function(require,module,exports){"use strict";var UI=require("./ui");var RES=require("./res");var Thing=require("./thing");var Utils=require("./utils");function NPC(img){this.hitbox=new Thing.Hitbox(0,0,5,5);var texture=Utils.getFrame(RES.NPC_TILESET,img||"npc1_south_1");this.sprite=new PIXI.Container;this.npcSprite=new PIXI.Sprite(texture);this.npcSprite.anchor.set(.5,1);this.sprite.addChild(this.npcSprite);this.textSprite=new PIXI.Sprite(UI.renderText("?"));this.textSprite.scale.set(3/5);this.textSprite.anchor.set(.5,1);this.textSprite.y=-this.npcSprite.height-2;this.textSprite.visible=false;this.sprite.addChild(this.textSprite);this.visibleTimer=0}NPC.prototype.setDialog=function(lines){this.textSprite.texture=UI.renderText(lines,{blackBG:true})};NPC.prototype.update=function(dt){var dirx=Math.sign(this.level.player.sprite.x-this.sprite.x);this.npcSprite.scale.x=Math.abs(this.npcSprite.scale.x)*dirx;if(this.visibleTimer>0){this.visibleTimer-=dt;if(this.visibleTimer<=0){this.textSprite.visible=false}}};NPC.prototype.handleHit=function(x,y,dmg){this.setDialog(["HEY CAREFUL","WITH THAT!"]);this.handlePlayerCollision()};NPC.prototype.handlePlayerCollision=function(player){if(!this.textSprite.visible){this.textSprite.visible=true}this.visibleTimer=1};module.exports=NPC},{"./res":23,"./thing":27,"./ui":30,"./utils":31}],20:[function(require,module,exports){"use strict";var UI=require("./ui");var RES=require("./res");var Utils=require("./utils");var Item=require("./item");var Thing=require("./thing");var WeaponSlot=require("./weaponslot");var Audio=require("./audio");var DAMAGE_TINT=16711680;var NO_TINT=16777215;function Player(controls){this.controls=controls;this.sprite=null;this.velx=0;this.vely=0;this.accelx=0;this.accely=0;this.frame=0;this.frames=null;this.lungeFrame=null;this.maxHealth=8;this.health=this.maxHealth;this.maxSpeed=40;this.numCoins=0;this.numArrows=0;this.armour=Item.Table.NONE;this.bow=Item.Table.NONE;this.sword=Item.Table.NONE;this.dirx=0;this.diry=0;this.dying=false;this.dead=false;this.lungeTimer=0;this.kills={};this.hitbox=new Thing.Hitbox(0,-4,6,6);this.setCharFrames(RES.FEMALE_MELEE,"melee1");this.sprite=new PIXI.Container;this.spriteChar=new PIXI.Sprite;this.spriteChar.anchor.set(.5,1);this.sprite.addChild(this.spriteChar);this.waterSprite=Utils.createSplashSprite();this.waterSprite.y=-1.5;this.sprite.addChild(this.waterSprite);this.textSprite=new PIXI.Sprite(UI.renderText("?"));this.textSprite.scale.set(3/5);this.textSprite.anchor.set(.5,1);this.textSprite.visible=false;this.sprite.addChild(this.textSprite);this.textTimeout=0;this.damageCooldown=1;this.damageTimer=0;this.weaponSlot=null;this.knockedTimer=0;this.knocked=0;this.bowWeaponSlot=new WeaponSlot.Bow(this);this.swordWeaponSlot=new WeaponSlot.Sword(this);this.sprite.addChild(this.bowWeaponSlot.sprite);this.sprite.addChild(this.swordWeaponSlot.sprite);this.bowWeaponSlot.sprite.visible=false;this.swordWeaponSlot.sprite.visible=false;this.handleCollisionCallback=function(thing){if(thing.handlePlayerCollision){thing.handlePlayerCollision(this)}}.bind(this)}Player.prototype.faceDirection=function(dirx){this.sprite.scale.x=Math.abs(this.sprite.scale.x)*Math.sign(dirx);this.textSprite.scale.x=Math.abs(this.textSprite.scale.x)*Math.sign(dirx)};Player.prototype.getFacing=function(){return Math.sign(this.sprite.scale.x)};Player.prototype.update=function(dt){var dirx=0;var diry=0;if(this.dead)return;if(this.textTimeout>0){this.textTimeout-=dt;if(this.textTimeout<=0){this.showMessage()}}if(this.dying){this.frame+=2.5*dt;if(this.frame>this.dyingFrames.length-1){this.frame=this.dyingFrames.length-1;this.dead=true}var frame=this.dyingFrames[this.frame|0];this.spriteChar.texture=frame;return}if(this.health<=0){this.dying=true;this.frame=0;this.weaponSlot=null;this.updatePlayerAppearance();this.spriteChar.tint=NO_TINT;this.level.stage.removeChild(this.sprite);this.level.stage.addChild(this.sprite);return}if(this.controls.primary.pressed)this.startAttack();if(!this.controls.primary.released)this.stopAttack();if(this.controls.swap.pressed){this.swapWeapons()}if(this.knockedTimer<=0){dirx=this.controls.getX();diry=this.controls.getY()}else{this.velx=this.knocked;this.knockedTimer-=dt}if(this.lungeTimer>0){this.lungeTimer-=dt}else{if(dirx){this.faceDirection(dirx);this.velx=dirx*this.maxSpeed}else{this.velx*=.75}}if(diry){this.vely=diry*this.maxSpeed}else{this.vely*=.75}if(dirx||diry){this.frame+=dt}else{this.frame=0}var speed=Math.sqrt(this.velx*this.velx+this.vely*this.vely);if(speed>this.maxSpeed){this.velx*=this.maxSpeed/speed;this.vely*=this.maxSpeed/speed}var w=this.spriteChar.texture.width*.75;if(this.velx){var x=this.sprite.x+this.velx*dt;if(!this.level.checkSolidAt(x,this.sprite.y,w)&&x-w/2>=this.level.camera.x&&x+w/2<=this.level.camera.x+this.level.camera.width){this.sprite.x=x}else{this.velx=0}}if(this.vely){var y=this.sprite.y+this.vely*dt;if(!this.level.checkSolidAt(this.sprite.x,y,w)){this.sprite.y=y}else{this.vely=0}}if(this.weaponSlot&&this.weaponSlot.update){this.weaponSlot.update(dt)}var tile=this.level.bg.getTileAt(this.sprite.x,this.sprite.y);if(tile.water){if(!this.waterSprite.visible)Audio.playSound(RES.SPLASH_SND);this.waterSprite.visible=true}else{this.waterSprite.visible=false}if(this.damageTimer>0){this.damageTimer-=dt;if(this.damageTimer<=0||this.damageCooldown-this.damageTimer>.1){this.spriteChar.tint=NO_TINT}}this.level.forEachThingHit(this.sprite.x,this.sprite.y,this.hitbox,this,this.handleCollisionCallback);var frame=this.frames[(this.frame*10|0)%this.frames.length];this.spriteChar.texture=frame};Player.prototype.setCharFrames=function(res,name){this.frames=Utils.getFrames(res,[name+"_south_1",name+"_south_2",name+"_south_3"]);this.lungeFrame=Utils.getFrame(res,name+"_lunge_1");this.dyingFrames=Utils.getFrames(res,["melee1_dying_1","melee1_dying_2","melee1_dying_3"])};Player.prototype.setArmour=function(item){this.armour=item;this.updatePlayerAppearance()};Player.prototype.updatePlayerAppearance=function(){var img="melee1";if(this.armour===Item.Table.LEATHER_ARMOUR)img="melee2";else if(this.armour==Item.Table.STEEL_ARMOUR)img="melee3";this.setCharFrames(RES.FEMALE_MELEE,img);var b=this.weaponSlot===this.bowWeaponSlot;this.bowWeaponSlot.sprite.visible=b;var b=this.weaponSlot===this.swordWeaponSlot;this.swordWeaponSlot.sprite.visible=b;if(this.weaponSlot)this.weaponSlot.update(0)};Player.prototype.upgradeSword=function(item){if(!this.weaponSlot){this.weaponSlot=this.swordWeaponSlot}this.sword=item;this.updatePlayerAppearance()};Player.prototype.upgradeBow=function(item){if(!this.weaponSlot){this.weaponSlot=this.bowWeaponSlot}this.bow=item;this.updatePlayerAppearance()};Player.prototype.upgradeArmour=function(item){this.setArmour(item);Audio.playSound(RES.POWERUP2_SND)};Player.prototype.healDamage=function(amt){if(this.health<this.maxHealth){this.health=Math.min(this.health+amt,this.maxHealth);Audio.playSound(RES.POWERUP4_SND,1.25)}};Player.prototype.takeDamage=function(amt,src){if(this.damageTimer<=0){var cooldown=this.damageCooldown;var knockedVel=100;var knockedTimer=.1;if(this.armour===Item.Table.LEATHER_ARMOUR){cooldown=this.damageCooldown*1.25;knockedVel=90;knockedTimer=.08;if(Utils.randint(1,4)===1){if(amt>1)amt--}}else if(this.armour===Item.Table.STEEL_ARMOUR){cooldown=this.damageCooldown*1.5;knockedVel=80;knockedTimer=.05;if(Utils.randint(1,2)===1){amt--}}Audio.playSound(RES.HIT_SND);this.health-=amt;this.damageTimer=this.damageCooldown;this.spriteChar.tint=DAMAGE_TINT;this.knocked=knockedVel*Math.sign(this.sprite.x-src.sprite.x);this.knockedTimer=knockedTimer}};Player.prototype.swapWeapons=function(){if(this.weaponSlot===this.swordWeaponSlot&&this.bow!==Item.Table.NONE){this.weaponSlot=this.bowWeaponSlot;this.updatePlayerAppearance()}else if(this.weaponSlot===this.bowWeaponSlot&&this.sword!==Item.Table.NONE){this.weaponSlot=this.swordWeaponSlot;this.updatePlayerAppearance()}};Player.prototype.startAttack=function(){if(this.weaponSlot)this.weaponSlot.startAttack()};Player.prototype.stopAttack=function(){if(this.weaponSlot)this.weaponSlot.stopAttack()};Player.prototype.handleMonsterKilled=function(monster){if(this.kills[monster.name]===undefined){this.kills[monster.name]={count:0,img:monster.frames[0]}}this.kills[monster.name].count++};Player.prototype.handleTakeItem=function(item){if(item.isArmour()&&item.isBetter(this.armour)){this.upgradeArmour(item);return true}if(item.isSword()&&item.isBetter(this.sword)){if(this.sword===Item.Table.NONE){if(this.controls.hasTouch){this.showMessage("TAP BUTTON"," TO ATTACK")}else{this.showMessage("  PRESS A","TO ATTACK")}}this.upgradeSword(item);return true}if(item.isBow()&&item.isBetter(this.bow)){if(this.bow===Item.Table.NONE){if(this.controls.hasTouch){this.showMessage("SWIPE BUTTON","    TO SWAP")}else{this.showMessage("PRESS X","TO SWAP")}}this.upgradeBow(item);return true}switch(item){case Item.Table.ARROW:this.numArrows+=5;break;case Item.Table.COIN:this.numCoins++;break;case Item.Table.SMALL_HEALTH:this.healDamage(2);break;case Item.Table.LARGE_HEALTH:this.healDamage(this.maxHealth);break}Audio.playSound(RES.COIN_SND);return true};Player.prototype.showMessage=function(){var lines=Array.prototype.slice.call(arguments);if(lines.length>0){this.textSprite.y=-this.spriteChar.texture.height-1;this.textSprite.texture=UI.renderText(lines,{blackBG:true});this.textSprite.visible=true;this.textTimeout=3}else{this.textSprite.visible=false}};module.exports=Player},{"./audio":2,"./item":15,"./res":23,"./thing":27,"./ui":30,"./utils":31,"./weaponslot":32}],21:[function(require,module,exports){"use strict";function ProgressBar(width,height,text){this.width=width;this.height=height;this.current=0;this.sprite=new PIXI.Container;this.barSprite=new PIXI.Sprite;this.textSprite=new PIXI.Text(text,{fontFamily:"Courier New",fontSize:20,fill:16777215,fontWeight:"bold",align:"center"});this.textSprite.y=height+5;this.sprite.addChild(this.barSprite);this.sprite.addChild(this.textSprite)}ProgressBar.prototype.setText=function(text){this.textSprite.text=text};ProgressBar.prototype.update=function(value){this.current=value;var canvas=document.createElement("canvas");canvas.width=this.width;canvas.height=this.height;var ctx=canvas.getContext("2d");ctx.fillStyle="#ddd";ctx.fillRect(0,0,this.width*this.current,this.height);ctx.strokeStyle="#f00";ctx.strokeRect(0,0,this.width,this.height);this.barSprite.texture=PIXI.Texture.fromCanvas(canvas)};module.exports=ProgressBar},{}],22:[function(require,module,exports){"use strict";var renderer=null;var container=null;var aspectRatio=1;module.exports={};module.exports.configure=function(div,aspect){PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST;PIXI.ticker.shared.autoStart=false;PIXI.ticker.shared.stop();var rect=div.getBoundingClientRect();if(rect.width===0||rect.height===0){throw Error("Invalid size for renderer")}var width=Math.round(rect.height*aspect);var height=rect.height;if(width>rect.width){width=rect.width;height=Math.round(rect.height/aspect)}renderer=new PIXI.CanvasRenderer({width:width,height:height,preserveDrawingBuffer:true});renderer.plugins.interaction.destroy();div.innerHTML="";div.appendChild(renderer.view);container=div;aspectRatio=aspect};module.exports.getContainer=function(){return container};module.exports.getRenderer=function(){return renderer};module.exports.resize=function(){var rect=container.getBoundingClientRect();var width=Math.round(rect.height*aspectRatio);var height=rect.height;if(width>rect.width){width=rect.width;height=Math.round(rect.width/aspectRatio)}renderer.resize(width,height)}},{}],23:[function(require,module,exports){"use strict";module.exports={MALE_MELEE:"media/rogue-like-8x8/Male-Melee.json",FEMALE_MELEE:"media/rogue-like-8x8/Girl-Melee.json",NPC_TILESET:"media/rogue-like-8x8/NPC.json",MAPTILES:"media/rogue-like-8x8/Tileset.json",ENEMIES:"media/rogue-like-8x8/Enemies.json",WEAPONS:"media/rogue-like-8x8/Weapons.json",GROUND_ITEMS:"media/rogue-like-8x8/GroundItems.json",UI:"media/rogue-like-8x8/UI.json",GAME_MUSIC:"media/music/A Journey Awaits2-lowfi.ogg",ATTACK_SWORD_SND:"media/effects/attack_sword2.wav",HIT_SND:"media/effects/hit.wav",SNAKE_HURT_SND:"media/effects/snake_hurt.wav",DEAD_SND:"media/effects/dead.wav",SPLASH_SND:"media/effects/splash.wav",ARROW_DING_SND:"media/effects/arrow_ding.wav",GO_SND:"media/effects/go.wav",COIN_SND:"media/effects/coin.wav",GATE_SND:"media/effects/gate.wav",DROP_SND:"media/effects/drop.wav",POWERUP1_SND:"media/effects/powerup1.wav",POWERUP2_SND:"media/effects/powerup2.wav",POWERUP3_SND:"media/effects/powerup3.wav",POWERUP4_SND:"media/effects/powerup4.wav",CHEST_SND:"media/effects/chest_open.wav",TILE_WIDTH:8,TILE_HEIGHT:8,WALL_HEIGHT:13,renderer:null}},{}],24:[function(require,module,exports){"use strict";function Scenery(frames){if(!(frames instanceof Array))frames=[frames];this.frames=frames;this.sprite=new PIXI.Sprite(frames[0]);this.sprite.anchor.set(.5,1);this.timer=0;this.velx=0;this.vely=0;this.fps=5;this.frame=0}Scenery.prototype.faceDirection=function(dir){this.sprite.scale.x=Math.abs(this.sprite.scale.x)*Math.sign(dir)};Scenery.prototype.update=function(dt){this.sprite.x+=this.velx*dt;this.sprite.y+=this.vely*dt;if(this.timer>0){this.timer-=dt;if(this.timer<=0){this.level.removeThing(this)}}if(this.frames.length>1){this.frame+=this.fps*dt;var img=this.frames[(this.frame|0)%this.frames.length];this.sprite.texture=img}};module.exports=Scenery},{}],25:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Thing=require("./thing");var Item=require("./item");var Audio=require("./audio");var SKEL_WARRIOR_IDLE=0;var SKEL_WARRIOR_START_APPROACH=1;var SKEL_WARRIOR_APPROACH=2;var SKEL_WARRIOR_ATTACKING=3;var SKEL_WARRIOR_POST_ATTACK=4;var SKEL_WARRIOR_HURT=5;var SKEL_WARRIOR_DEAD=6;function SkelWarrior(state){this.name="Skeleton";this.idleFrame=Utils.getFrame(RES.ENEMIES,"skeleton_warrior_south_1");this.frames=Utils.getFrames(RES.ENEMIES,SkelWarrior.FRAMES);this.speed=20;this.health=3;this.frame=0;this.facing=1;this.dead=false;this.approachDist=30;this.timer=null;this.counter=0;this.sprite=new PIXI.Container(this.frames[0]);this.monsterSprite=new PIXI.Sprite;this.monsterSprite.anchor.set(.5,6.5/8);this.sprite.addChild(this.monsterSprite);this.waterSprite=Utils.createSplashSprite();this.waterSprite.y=-.5;this.sprite.addChild(this.waterSprite);this.knocked=0;this.knockedTimer=0;this.state=state||SKEL_WARRIOR_START_APPROACH;this.hitbox=new Thing.Hitbox(0,-1,6,8)}SkelWarrior.FRAMES=["skeleton_warrior_south_2","skeleton_warrior_south_3"];SkelWarrior.prototype.getDropTable=function(){return[[Item.Table.LARGE_HEALTH,5],[Item.Table.LEATHER_ARMOUR,1],[Item.Table.SMALL_BOW,1]]};SkelWarrior.prototype.update=function(dt){switch(this.state){case SKEL_WARRIOR_ATTACKING:this.updateAttacking(dt);break;case SKEL_WARRIOR_POST_ATTACK:this.timer-=dt;if(this.timer<=0){this.state=SKEL_WARRIOR_START_APPROACH}break;case SKEL_WARRIOR_START_APPROACH:this.timer=null;this.state=SKEL_WARRIOR_APPROACH;break;case SKEL_WARRIOR_APPROACH:this.updateApproach(dt);break;case SKEL_WARRIOR_HURT:this.updateHurt(dt);break;case SKEL_WARRIOR_DEAD:this.level.removeThing(this);break}};SkelWarrior.prototype.updateAttacking=function(dt){if(this.timer>0){this.timer-=dt;return}var player=this.level.player;var dx=0,dy=0;if(player.sprite.x>this.sprite.x){dx=2.5*this.speed*dt;this.facing=1}else{dx=-2.5*this.speed*dt;this.facing=-1}this.sprite.scale.x=this.facing*Math.abs(this.sprite.scale.x);if(Math.abs(this.sprite.x-player.sprite.x)<5){this.timer=.25;this.state=SKEL_WARRIOR_POST_ATTACK;return}var dist=player.sprite.y-this.sprite.y;if(Math.abs(dist)>2){dy=dt*this.speed*Math.sign(dist)/2}var tile=this.level.bg.getTileAt(this.sprite.x+dx,this.sprite.y);if(!tile.solid){this.sprite.x+=dx;this.waterSprite.visible=tile.water}var tile2=this.level.bg.getTileAt(this.sprite.x,this.sprite.y+dy);if(!tile2.solid){if(tile.solid)this.sprite.y+=3*dy;else{this.sprite.y+=dy;this.waterSprite.visible=tile2.water}}this.frame+=4*dt;this.monsterSprite.texture=this.frames[this.frame%this.frames.length|0]};SkelWarrior.prototype.updateApproach=function(dt){var player=this.level.player;var targetx=0;if(this.sprite.x<player.sprite.x){targetx=player.sprite.x-this.approachDist;this.facing=1}else if(this.sprite.x>player.sprite.x){targetx=player.sprite.x+this.approachDist;this.facing=-1}this.sprite.scale.x=this.facing*Math.abs(this.sprite.scale.x);if(this.timer===null){var dist=Math.abs(this.sprite.x-player.sprite.x);if(dist>=this.approachDist*.9&&dist<=this.approachDist*1.1){this.timer=1.5}}else{this.timer-=dt;if(this.timer<=0){this.state=SKEL_WARRIOR_ATTACKING;this.timer=.4;return}}var dx=0;var dy=0;targetx+=20*Math.cos(this.frame/6);if(Math.abs(this.sprite.x-targetx)>2){dx=dt*Math.sign(targetx-this.sprite.x)}var speed=this.speed;if(this.facing*dx<0)speed=this.speed/1.5;var targety=player.sprite.y+35*Math.pow(Math.sin(this.frame/4),2)-20;var dist=targety-this.sprite.y;if(Math.abs(dist)>1){dy=dt*Math.sign(dist)}dx*=speed;dy*=speed;var tile=this.level.bg.getTileAt(this.sprite.x+dx,this.sprite.y);if(!tile.solid){this.sprite.x+=dx;this.waterSprite.visible=tile.water}var tile=this.level.bg.getTileAt(this.sprite.x,this.sprite.y+dy);if(!tile.solid){this.sprite.y+=dy;this.waterSprite.visible=tile.water}this.frame+=4*dt;this.monsterSprite.texture=this.frames[this.frame%this.frames.length|0]};SkelWarrior.prototype.updateHurt=function(dt){if(this.knockedTimer>0){var dx=this.knocked*dt;var tile=this.level.bg.getTileAt(this.sprite.x+dx,this.sprite.y);if(!tile.solid){this.sprite.x+=dx}this.knockedTimer-=dt}else{this.state=SKEL_WARRIOR_APPROACH}};SkelWarrior.prototype.handleHit=function(srcx,srcy,dmg){var player=this.level.player;if(this.state===SKEL_WARRIOR_DEAD)return false;this.health-=1;if(this.health<=0){Audio.playSound(RES.DEAD_SND);this.state=SKEL_WARRIOR_DEAD;this.level.handleTreasureDrop(this.getDropTable(),this.sprite.x,this.sprite.y);player.handleMonsterKilled(this);this.dead=true}else{Audio.playSound(RES.SNAKE_HURT_SND);this.knocked=Math.sign(this.sprite.x-srcx)*60;this.knockedTimer=.1;this.state=SKEL_WARRIOR_HURT}var tile=this.level.bg.getTileAt(this.sprite.x,this.sprite.y);if(!tile.water){this.level.createBloodSpatter(this.sprite.x,this.sprite.y-1,["dust1","dust2","dust3","dust4"])}return true};SkelWarrior.prototype.handlePlayerCollision=function(player){player.takeDamage(2,this)};module.exports=SkelWarrior},{"./audio":2,"./item":15,"./res":23,"./thing":27,"./utils":31}],26:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Thing=require("./thing");var Item=require("./item");var Audio=require("./audio");var SNAKE_IDLE=0;var SNAKE_ATTACKING=1;var SNAKE_HURT=2;var SNAKE_DEAD=3;function Snake(state){this.name="Snake";this.frames=Utils.getFrames(RES.ENEMIES,Snake.FRAMES);this.speed=16;this.health=3;this.frame=0;this.facing=1;this.dead=false;this.travel=0;this.sprite=new PIXI.Container;this.snakeSprite=new PIXI.Sprite(this.frames[0]);this.snakeSprite.anchor.set(.5,6.5/8);this.sprite.addChild(this.snakeSprite);this.waterSprite=Utils.createSplashSprite();this.waterSprite.y=-1.25;this.sprite.addChild(this.waterSprite);this.knocked=0;this.knockedTimer=0;this.state=state||SNAKE_ATTACKING;this.hitbox=new Thing.Hitbox(0,-1,6,6)}Snake.FRAMES=["snake_south_1","snake_south_2"];Snake.prototype.getDropTable=function(){return[[Item.Table.COIN,2],[Item.Table.ARROW,1],[Item.Table.SMALL_HEALTH,1]]};Snake.prototype.update=function(dt){if(this.state===SNAKE_IDLE)this.updateIdle(dt);else if(this.state===SNAKE_ATTACKING)this.updateAttacking(dt);else if(this.state===SNAKE_HURT)this.updateHurt(dt);else if(this.state===SNAKE_DEAD){this.level.removeThing(this)}};Snake.prototype.updateIdle=function(dt){var player=this.level.player;this.frame+=2*dt;this.snakeSprite.texture=this.frames[this.frame%this.frames.length|0];this.facing=Math.sign(Math.cos(this.frame/10));this.sprite.scale.x=this.facing*Math.abs(this.sprite.scale.x);if(Math.abs(player.sprite.x-this.sprite.x)<this.level.camera.width/3&&this.facing*(player.sprite.x-this.sprite.x)>0){this.state=SNAKE_ATTACKING}};Snake.prototype.updateAttacking=function(dt){var dx=0,dy=0;var player=this.level.player;if(this.travel>0){dx=this.speed*dt*this.facing;this.sprite.scale.x=this.facing*Math.abs(this.sprite.scale.x);this.travel-=Math.abs(dx)}else{if(player.sprite.x<this.sprite.x)this.facing=-1;else this.facing=1;this.travel=Utils.randint(16,20)}var dist=player.sprite.y-this.sprite.y;if(Math.abs(dist)>5){dy=dt*Math.sign(dist)*this.speed/2}var tile=this.level.bg.getTileAt(this.sprite.x+dx,this.sprite.y);if(!tile.solid){this.sprite.x+=dx;this.waterSprite.visible=tile.water}var tile2=this.level.bg.getTileAt(this.sprite.x,this.sprite.y+dy);if(!tile2.solid){if(tile.solid)this.sprite.y+=1*dy;else{this.sprite.y+=dy;this.waterSprite.visible=tile2.water}}this.frame+=4*dt;this.snakeSprite.texture=this.frames[this.frame%this.frames.length|0]};Snake.prototype.updateHurt=function(dt){this.snakeSprite.texture=this.frames[1];if(this.knockedTimer>0){var dx=this.knocked*dt;var tile=this.level.bg.getTileAt(this.sprite.x+dx,this.sprite.y);if(!tile.solid){this.sprite.x+=dx}this.knockedTimer-=dt}else{this.state=SNAKE_ATTACKING;this.travel=0}};Snake.prototype.handleHit=function(srcx,srcy,dmg){var player=this.level.player;if(this.state===SNAKE_DEAD)return false;this.health-=1;if(this.health<=0){Audio.playSound(RES.DEAD_SND);this.state=SNAKE_DEAD;this.level.handleTreasureDrop(this.getDropTable(),this.sprite.x,this.sprite.y);player.handleMonsterKilled(this);this.dead=true}else{Audio.playSound(RES.SNAKE_HURT_SND);this.knocked=Math.sign(this.sprite.x-srcx)*60;this.knockedTimer=.1;this.state=SNAKE_HURT}var tile=this.level.bg.getTileAt(this.sprite.x,this.sprite.y);if(!tile.water){this.level.createBloodSpatter(this.sprite.x,this.sprite.y-1)}return true};Snake.prototype.handlePlayerCollision=function(player){player.takeDamage(1,this)};function Rat(){Snake.call(this);this.name="Rat";this.frames=Utils.getFrames(RES.ENEMIES,Rat.FRAMES);this.health=1;this.speed=20;this.frame=0;this.facing=1;this.travel=20;this.knocked=0;this.knockedTimer=0;this.state=SNAKE_ATTACKING;this.snakeSprite.texture=this.frames[0];this.waterSprite.y=-.9}Rat.FRAMES=["rat_south_1","rat_south_2"];Rat.prototype=Object.create(Snake.prototype);function Scorpion(){Snake.call(this);this.name="Scorpion";this.frames=Utils.getFrames(RES.ENEMIES,Scorpion.FRAMES);this.health=4;this.speed=10;this.frame=0;this.facing=1;this.travel=20;this.knocked=0;this.knockedTimer=0;this.state=SNAKE_ATTACKING;this.snakeSprite.texture=this.frames[0];this.waterSprite.y=-.85}Scorpion.FRAMES=["scorpion_south_1","scorpion_south_2"];Scorpion.prototype=Object.create(Snake.prototype);module.exports={Snake:Snake,Rat:Rat,Scorpion:Scorpion}},{"./audio":2,"./item":15,"./res":23,"./thing":27,"./utils":31}],27:[function(require,module,exports){"use strict";var Utils=require("./utils");function Thing(){this.hitbox=new Thing.Hitbox(0,0,5,5);var texture=Utils.getFrame(RES.GROUND_ITEMS,"coin");this.sprite=new PIXI.Sprite(texture);this.sprite.anchor.set(0,0)}Thing.prototype.update=function(dt){};Thing.prototype.handleHit=function(x,y,dmg){};Thing.prototype.handlePlayerCollision=function(player){};Thing.Hitbox=function(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h};module.exports=Thing},{"./utils":31}],28:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Render=require("./render");var UI=require("./ui");var GameControls=require("./controls");var LevelGenerator=require("./genlevel");var Player=require("./player");var Item=require("./item");var Scenery=require("./scenery");var SnakeLike=require("./snake");var Goblin=require("./goblin");var SkelWarrior=require("./skel_warrior");var Ghost=require("./ghost");var LevelScreen=require("./levelscreen");var Snake=SnakeLike.Snake;var Rat=SnakeLike.Rat;var Scorpion=SnakeLike.Scorpion;function TitleScreen(){var _this=this;this.PLAYING_INTRO=1;this.NEW_GAME=2;this.screenHeight=80;this.screenWidth=Math.round(LevelScreen.getAspectRatio()*this.screenHeight);var scale=Render.getRenderer().height/this.screenHeight;this.stage=new PIXI.Container;this.stage.scale.set(scale);this.state=this.PLAYING_INTRO;this.bg=new PIXI.Sprite(Utils.getFrame(RES.UI,"brown3"));this.bg.anchor.set(0,0);this.bg.scale.set(this.screenWidth/this.bg.texture.width+1,this.screenHeight/this.bg.texture.height+1);this.stage.addChild(this.bg);this.delay=0;var txt=new PIXI.Sprite(Utils.getFrame(RES.UI,"title-text"));txt.anchor.set(.5,.5);txt.tint=16711680;txt.x=this.screenWidth/2;txt.y=15;this.stage.addChild(txt);txt=new PIXI.Sprite(Utils.getFrame(RES.UI,"demo-text"));txt.anchor.set(.5,.5);txt.tint=16711680;txt.x=this.screenWidth/2;txt.y=25;this.stage.addChild(txt);txt=new PIXI.Sprite(UI.renderText("CLICK OR PRESS SPACE TO PLAY"));txt.scale.set(.75);txt.anchor.set(.5,.5);txt.tint=16711680;txt.x=this.screenWidth/2;txt.y=35;this.stage.addChild(txt);txt=new PIXI.Sprite(UI.renderText("PROGRAMMING BY PETER ROGERS. ARTWORK IS PUBLIC DOMAIN."));txt.scale.set(.55);txt.anchor.set(.5,.5);txt.tint=16711680;txt.x=this.screenWidth/2;txt.y=70;this.stage.addChild(txt);txt=new PIXI.Sprite(UI.renderText('MUSIC "A JOURNEY AWAITS" BY PIERRA BONDOERFFER @PBONDOER'));txt.scale.set(.55);txt.anchor.set(.5,.5);txt.tint=16711680;txt.x=this.screenWidth/2;txt.y=75;this.stage.addChild(txt);this.mouseClicked=false;this.touchClicked=false;this.onMouseUp=function(evt){_this.mouseClicked=true};this.onTouchEnd=function(evt){_this.touchClicked=true};Render.getContainer().addEventListener("mouseup",this.onMouseUp);Render.getContainer().addEventListener("touchend",this.onTouchEnd);this.sequence=new Utils.Sequence({stage:this.stage,level:null,player:null,screenWidth:this.screenWidth,screenHeight:this.screenHeight},"start",function(dt){this.level=LevelGenerator.generateEmpty(2,Math.round(this.screenWidth/RES.TILE_WIDTH)+4,"smooth_floor_m");this.level.stage.x=-RES.TILE_WIDTH*2;this.level.stage.y=40;this.level.camera.width=this.level.getWidth();this.stage.addChild(this.level.stage);this.screenLeft=-this.level.stage.x;this.screenRight=this.screenLeft+this.screenWidth;this.controls=new GameControls.ManualControls;this.player=new Player(this.controls);this.player.sprite.x=2;this.player.sprite.y=20;this.level.addThing(this.player);this.monsterChoices=[Rat.FRAMES,Snake.FRAMES,Scorpion.FRAMES,SkelWarrior.FRAMES,Goblin.FRAMES,Ghost.FRAMES];this.monsterChoice=0;this.monster=new Scenery(Utils.getFrames(RES.ENEMIES,this.monsterChoices[0]));this.monster.sprite.y=this.player.sprite.y;this.level.addThing(this.monster);return this.NEXT},function(dt){this.controls.dirx=1;this.player.update(dt);if(this.player.sprite.x>this.screenRight+4){this.monster.sprite.x=this.screenRight+16;return this.NEXT}},"loop",function(dt){this.controls.dirx=-1;this.player.update(dt);this.monster.velx=-20;this.monster.update(dt);this.monster.faceDirection(-1);if(this.player.sprite.x<this.screenLeft-4){this.player.upgradeSword(Item.Table.SMALL_SWORD);return this.NEXT}},function(dt){this.controls.dirx=1;this.player.update(dt);this.monster.velx=20;this.monster.update(dt);this.monster.faceDirection(1);if(this.player.sprite.x>this.screenRight+4){this.monsterChoice++;var choice=this.monsterChoices[this.monsterChoice%this.monsterChoices.length];this.monster.frames=Utils.getFrames(RES.ENEMIES,choice);return"loop"}})}TitleScreen.prototype.destroy=function(){Render.getContainer().removeEventListener("mouseup",this.onMouseUp);Render.getContainer().removeEventListener("touchend",this.onTouchEnd)};TitleScreen.prototype.update=function(dt){if(this.delay>0){this.delay-=dt;return}this.sequence.update(dt);if(GameControls.getControls().space.released||this.mouseClicked||this.touchClicked){this.state=this.NEW_GAME}};TitleScreen.prototype.render=function(){Render.getRenderer().render(this.stage)};TitleScreen.prototype.handleResize=function(){if(this.stage){var scale=Math.min(Render.getRenderer().width/this.screenWidth,Render.getRenderer().height/this.screenHeight);this.stage.scale.set(scale)}};module.exports=TitleScreen},{"./controls":5,"./genlevel":10,"./ghost":11,"./goblin":12,"./item":15,"./levelscreen":17,"./player":20,"./render":22,"./res":23,"./scenery":24,"./skel_warrior":25,"./snake":26,"./ui":30,"./utils":31}],29:[function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Utils=require("./utils");var RES=require("./res");var Render=require("./render");var GameControls=require("./controls");var TouchAdapter=function(){function TouchAdapter(touchUI,controls){_classCallCheck(this,TouchAdapter);this.touchUI=touchUI;this.controls=controls;this.attackTouch=null;this.movementTouch=null;this.tapTouch=null;this.controls.hasTouch=true;this.onTouchStart=this.handleTouchStart.bind(this);this.onTouchMove=this.handleTouchMove.bind(this);this.onTouchEnd=this.handleTouchEnd.bind(this);this.viewElement=Render.getRenderer().view;this.viewElement.addEventListener("touchstart",this.onTouchStart);this.viewElement.addEventListener("touchmove",this.onTouchMove);this.viewElement.addEventListener("touchend",this.onTouchEnd);this.viewElement.addEventListener("touchcancel",this.onTouchEnd)}_createClass(TouchAdapter,[{key:"destroy",value:function destroy(){if(this.viewElement===null)return;console.log("REMOVING EVENT HANDLERS");this.viewElement.removeEventListener("touchstart",this.onTouchStart);this.viewElement.removeEventListener("touchmove",this.onTouchMove);this.viewElement.removeEventListener("touchend",this.onTouchEnd);this.viewElement.removeEventListener("touchcancel",this.onTouchEnd);this.viewElement=null;this.controls.hasTouch=false}},{key:"handleTouchStart",value:function handleTouchStart(event){var Touch=function Touch(id,x,y){_classCallCheck(this,Touch);this.id=id;this.startx=x;this.starty=y};var viewRect=this.viewElement.getBoundingClientRect();var padArea=this.touchUI.padSprite.getBounds();var btnArea=this.touchUI.attackSprite.getBounds();var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=event.changedTouches[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var touch=_step.value;var x=touch.clientX-viewRect.left;var y=touch.clientY-viewRect.top;if(this.attackTouch===null&&btnArea.contains(x,y)){this.attackTouch=new Touch(touch.identifier,x,y);this.controls.primary.press()}else if(this.movementTouch===null&&padArea.contains(x,y)){this.movementTouch=new Touch(touch.identifier,x,y)}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}event.preventDefault()}},{key:"handleTouchMove",value:function handleTouchMove(event){var viewRect=this.viewElement.getBoundingClientRect();var padArea=this.touchUI.padSprite.getBounds();var orad=padArea.width/4;var irad=orad*.1;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=event.changedTouches[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var touch=_step2.value;if(this.movementTouch!==null&&this.movementTouch.id===touch.identifier){var x=touch.clientX-viewRect.left;var y=touch.clientY-viewRect.top;var dx=x-(padArea.x+padArea.width/2);var dy=y-(padArea.y+padArea.height/2);var magx=Math.min((Math.abs(dx)-irad)/orad,1);var magy=Math.min((Math.abs(dy)-irad)/orad,1);if(dx>=irad){this.controls.left.release();this.controls.right.press(magx)}else if(dx<=-irad){this.controls.left.press(magx);this.controls.right.release()}else{this.controls.left.release();this.controls.right.release()}if(dy>=irad){this.controls.up.release();this.controls.down.press(magy)}else if(dy<=-irad){this.controls.up.press(magy);this.controls.down.release()}else{this.controls.up.release();this.controls.down.release()}}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}event.preventDefault()}},{key:"handleTouchEnd",value:function handleTouchEnd(event){var _this=this;var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=event.changedTouches[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var touch=_step3.value;if(this.attackTouch!==null&&this.attackTouch.id===touch.identifier){var viewRect=this.viewElement.getBoundingClientRect();var x=touch.clientX-viewRect.left;var y=touch.clientY-viewRect.top;var btnArea=this.touchUI.attackSprite.getBounds();if(!btnArea.contains(x,y)){this.controls.swap.press();setTimeout(function(){_this.controls.swap.release()},10)}this.attackTouch=null;this.controls.primary.release()}if(this.movementTouch!==null&&this.movementTouch.id===touch.identifier){this.controls.up.release();this.controls.down.release();this.controls.left.release();this.controls.right.release();this.movementTouch=null}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}event.preventDefault()}}]);return TouchAdapter}();var TouchUI=function(){function TouchUI(){_classCallCheck(this,TouchUI);this.container=new PIXI.Container;this.padSprite=new PIXI.Sprite(Utils.getFrame(RES.UI,"controller-pad"));this.padSprite.anchor.set(.5,.5);this.attackSprite=new PIXI.Sprite(Utils.getFrame(RES.UI,"controller-attack"));this.attackSprite.anchor.set(.5,.5);this.container.alpha=.25;this.container.addChild(this.padSprite);this.container.addChild(this.attackSprite);this.touchAdapter=new TouchAdapter(this,GameControls.getControls())}_createClass(TouchUI,[{key:"destroy",value:function destroy(){if(this.container!==null){this.container.destroy();this.container=null;this.touchAdapter.destroy();this.touchAdapter=null}}},{key:"doLayout",value:function doLayout(width,height){this.padSprite.x=this.padSprite.width/2+1;this.padSprite.y=height/2+4;this.attackSprite.x=width-this.attackSprite.width/2-2;this.attackSprite.y=height/2+1}}]);return TouchUI}();module.exports=TouchUI},{"./controls":5,"./render":22,"./res":23,"./utils":31}],30:[function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var RES=require("./res");var Utils=require("./utils");var Render=require("./render");var Item=require("./item");var Audio=require("./audio");var GameControls=require("./controls");function renderText(lines,options){if(!(lines instanceof Array))lines=[lines];var maxWidth=0;var cnt=new PIXI.Container;var y=1;for(var row=0;row<lines.length;row++){var x=1;var msg=lines[row];var height=0;for(var n=0;n<msg.length;n++){var sprite=new PIXI.Sprite(Utils.getFrame(RES.UI,msg[n]));sprite.anchor.set(0,0);sprite.x=x;sprite.y=y;if(msg[n]===" ")x+=(sprite.width+1)/2;else x+=sprite.width+1;cnt.addChild(sprite);height=Math.max(height,sprite.height)}maxWidth=Math.max(maxWidth,x);y+=height+1}if(options&&options.blackBG){var bg=new PIXI.Sprite(Utils.getFrame(RES.UI,"black"));bg.scale.set(maxWidth/bg.width,y/bg.height);cnt.addChildAt(bg,0)}var renderTexture=PIXI.RenderTexture.create(maxWidth,y);Render.getRenderer().render(cnt,renderTexture);return renderTexture}function HealthUI(){this.player=null;this.sprite=new PIXI.Container;this.hearts=[];this.fullHeart=Utils.getFrame(RES.UI,"full_bigheart");this.halfHeart=Utils.getFrame(RES.UI,"half_bigheart");this.emptyHeart=Utils.getFrame(RES.UI,"empty_bigheart");for(var n=0;n<3;n++){this.addHeart()}}HealthUI.prototype.addHeart=function(){var heart=new PIXI.Sprite(this.fullHeart);this.hearts.push(heart);this.sprite.addChild(heart);var x=-this.hearts.length*(this.fullHeart.width+1);var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.hearts[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _heart=_step.value;_heart.x=x;x+=this.fullHeart.width+1}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}};HealthUI.prototype.removeHeart=function(){if(this.hearts.length>0){this.sprite.removeChild(this.hearts.pop())}};HealthUI.prototype.update=function(dt){if(!this.player)return;while(this.hearts.length<Math.floor(this.player.maxHealth/2)){this.addHeart()}while(this.hearts.length>Math.floor(this.player.maxHealth/2)){this.removeHeart()}for(var n=0;n<this.hearts.length;n++){var img=null;if(n<Math.floor(this.player.health/2)){img=this.fullHeart}else if(n<Math.floor((this.player.health+1)/2)){img=this.halfHeart}else{img=this.emptyHeart}this.hearts[n].texture=img}};function ItemSlotUI(item,args){this.sprite=new PIXI.Container;this.baseItem=item;this.item=item;this.count=0;this.itemSprite=new PIXI.Sprite(Utils.getFrame(RES.GROUND_ITEMS,item.image));this.itemSprite.anchor.set(.5,0);this.itemSprite.x=.5;this.itemSprite.y=0;this.slotSprite=new PIXI.Sprite(Utils.getFrame(RES.UI,"small_slot"));this.slotSprite.anchor.set(.5,0);this.sprite.addChild(this.slotSprite);this.sprite.addChild(this.itemSprite);if(args&&args.x)this.itemSprite.x+=args.x;if(args&&args.y)this.itemSprite.y+=args.y;if(args&&args.showCount){var img=renderText("--");this.textSprite=new PIXI.Sprite(img);this.textSprite.anchor.set(.5,.5);this.textSprite.x=0;this.textSprite.y=12;this.textSprite.scale.set(.75);this.sprite.addChild(this.textSprite)}}ItemSlotUI.prototype.setCount=function(count){if(this.textSprite&&this.count!==count){this.count=count;if(count===0)count="--";else if(count<9)count="0"+count;this.textSprite.texture=renderText(""+count)}};ItemSlotUI.prototype.setItem=function(item){if(item===Item.Table.NONE)item=this.baseItem;if(this.item!==item){this.item=item;this.itemSprite.texture=Utils.getFrame(RES.GROUND_ITEMS,item.image)}};function InventoryUI(){this.player=null;this.sprite=new PIXI.Container;this.armourSlot=new ItemSlotUI(Item.Table.NO_ARMOUR);this.swordSlot=new ItemSlotUI(Item.Table.NO_SWORD);this.bowSlot=new ItemSlotUI(Item.Table.NO_BOW,{x:-.5});this.arrowSlot=new ItemSlotUI(Item.Table.ARROW,{showCount:true});this.coinSlot=new ItemSlotUI(Item.Table.COIN,{showCount:true,x:-.5,y:.5});this.slots=[this.armourSlot,this.swordSlot,this.bowSlot,this.arrowSlot,this.coinSlot];var x=0;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.slots[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var slot=_step2.value;this.sprite.addChild(slot.sprite);slot.sprite.x=x;x+=slot.slotSprite.texture.width+1}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}InventoryUI.prototype.update=function(dt){if(this.player){this.armourSlot.setItem(this.player.armour);this.swordSlot.setItem(this.player.sword);this.bowSlot.setItem(this.player.bow);this.arrowSlot.setCount(this.player.numArrows);this.coinSlot.setCount(this.player.numCoins)}};var Button=function(){function Button(stateList){var _this=this;_classCallCheck(this,Button);this.onclick=null;this.sprite=new PIXI.Sprite;this.sprite.anchor.set(0,0);this.states={};this.state=null;stateList.forEach(function(arg){var name=arg[0];var img=arg[1];_this.states[name]=Utils.getFrame(RES.UI,img);if(!_this.state)_this.state=name});this.setState(this.state);this.sprite.interactive=true;this.sprite.click=function(){if(_this.onclick)_this.onclick()}}_createClass(Button,[{key:"setState",value:function setState(state){if(state&&this.states.hasOwnProperty(state)){this.sprite.texture=this.states[state];this.state=state}}}]);return Button}();var GameUI=function(){function GameUI(){_classCallCheck(this,GameUI);this.container=new PIXI.Container;this.healthUI=new HealthUI(this);this.inventoryUI=new InventoryUI(this);this.bg=new PIXI.Sprite(Utils.getFrame(RES.UI,"black"));this.audioButton=new Button([["on","audio-on"],["off","audio-off"]]);this.container.addChild(this.bg);this.container.addChild(this.healthUI.sprite);this.container.addChild(this.inventoryUI.sprite);this.container.addChild(this.audioButton.sprite);this.onMouseDown=this.handleMouseDown.bind(this);this.onTouchStart=this.handleTouchStart.bind(this);this.viewElement=Render.getRenderer().view;this.viewElement.addEventListener("mousedown",this.onMouseDown);this.viewElement.addEventListener("touchstart",this.onTouchStart)}_createClass(GameUI,[{key:"destroy",value:function destroy(){if(this.container){this.setPlayer(null);this.container.destroy();this.container=null;this.healthUI=null;this.inventoryUI=null;this.bg=null;this.audioButton=null;if(GameControls.getControls().hasTouch){this.viewElement.removeEventListener("touchstart",this.onTouchStart)}else{this.viewElement.removeEventListener("mousedown",this.onMouseDown)}this.viewElement=null}}},{key:"handleTouchStart",value:function handleTouchStart(event){var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=event.changedTouches[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var touch=_step3.value;this.handlePointerDown(touch.clientX,touch.clientY)}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}},{key:"handleMouseDown",value:function handleMouseDown(event){this.handlePointerDown(event.clientX,event.clientY)}},{key:"handlePointerDown",value:function handlePointerDown(x,y){var viewRect=this.viewElement.getBoundingClientRect();var xp=x-viewRect.left;var yp=y-viewRect.top;var rect=this.audioButton.sprite.getBounds();if(rect.contains(xp,yp)){if(this.audioButton.state==="on"){this.audioButton.setState("off");Audio.setEnabled(false)}else{this.audioButton.setState("on");Audio.setEnabled(true)}}}},{key:"setPlayer",value:function setPlayer(player){this.healthUI.player=player;this.inventoryUI.player=player}},{key:"update",value:function update(dt){this.healthUI.update(dt);this.inventoryUI.update(dt)}},{key:"doLayout",value:function doLayout(width,height){this.inventoryUI.sprite.position.set(5.5,1);this.audioButton.sprite.position.set(width-this.audioButton.sprite.width-1,1);this.healthUI.sprite.position.set(86,2);this.bg.scale.set(width/this.bg.texture.width,height/this.bg.texture.height)}}]);return GameUI}();module.exports={renderText:renderText,HealthUI:HealthUI,InventoryUI:InventoryUI,ItemSlotUI:ItemSlotUI,GameUI:GameUI}},{"./audio":2,"./controls":5,"./item":15,"./render":22,"./res":23,"./utils":31}],31:[function(require,module,exports){"use strict";var RES=require("./res");function randint(a,b){return a+(b-a+1)*Math.random()|0}function randUniform(a,b){return a+(b-a+1)*Math.random()}function randomChoice(lst){var n=Math.random()*lst.length|0;return lst[n]}function createGrid(rows,cols,value){var grid=[];grid.rows=rows;grid.cols=cols;for(var row=0;row<rows;row++){grid[row]=[];for(var col=0;col<cols;col++){grid[row][col]=value}}return grid}function createSplashSprite(){var waterSprite=new PIXI.Sprite;waterSprite.anchor.set(.5,.5);waterSprite.visible=false;waterSprite.texture=getFrame(RES.MAPTILES,"treading_water");return waterSprite}function getTextures(res){if(!res)throw Error("must specify a resource");return PIXI.loader.resources[res].textures}function getFrame(res,name){return getTextures(res)[name]}function getFrames(res,names){var frames=[];for(var n=0;n<names.length;n++){var frame=getTextures(res)[names[n]];if(!frame)console.log("ERROR: missing frame "+names[n]);frames.push(frame)}return frames}function updateDict(dict,other){for(var key in other){dict[key]=other[key]}}function Sequence(){var args=arguments[0];for(var key in args){this[key]=args[key]}this.done=false;this.numSteps=arguments.length-1;this.labels={};for(var n=1;n<arguments.length;n++){if(arguments[n].constructor===String){this.labels[arguments[n]]=n-1}else{var name="func_"+(n-1);this[name]=arguments[n]}}this.state=0;this.delay=0;this.NEXT=true}Sequence.prototype.update=function(dt){if(this.done)return;if(this.delay>0){this.delay-=dt;return}var fname="func_"+this.state;if(this[fname]){var ret=this[fname](dt);if(ret===this.NEXT){this.state++}else if(ret){this.state=this.labels[ret]}}else{this.state++}if(this.state>=this.numSteps){this.done=true}};module.exports={randint:randint,randUniform:randUniform,randomChoice:randomChoice,Sequence:Sequence,createGrid:createGrid,createSplashSprite:createSplashSprite,getFrame:getFrame,getFrames:getFrames,getTextures:getTextures}},{"./res":23}],32:[function(require,module,exports){"use strict";var RES=require("./res");var Utils=require("./utils");var Thing=require("./thing");var Audio=require("./audio");var ARROW_FLIGHT=0;var ARROW_FALLING=1;var ARROW_DISAPPEAR=2;function SwordWeaponSlot(player){this.sprite=new PIXI.Sprite;this.sprite.anchor.set(4/8,3.9/8);this.sprite.x=2.5;this.sprite.y=-4;this.sprite.rotation=-Math.PI/3;this.attackCooldown=0;this.weaponReach=3.25;this.player=player;this.hitbox=new Thing.Hitbox(0,-4,10,6);this.textureName=null;this.setTexture("sword2");this.handleHitCallback=function(hit){if(hit.handleHit){hit.handleHit(this.player.sprite.x,this.player.sprite.y,1)}}.bind(this)}SwordWeaponSlot.prototype.update=function(dt){if(this.attackCooldown>0){this.attackCooldown-=dt;if(this.attackCooldown<=0){this.sprite.x=2.5;this.sprite.rotation=-Math.PI/3}}};SwordWeaponSlot.prototype.setTexture=function(name){if(this.textureName!==name){this.sprite.texture=Utils.getFrame(RES.WEAPONS,name);this.textureName=name}};SwordWeaponSlot.prototype.startAttack=function(){if(this.attackCooldown>0)return;Audio.playSound(RES.ATTACK_SWORD_SND);this.sprite.rotation=0;this.sprite.x=3.5;this.attackCooldown=.15;this.player.level.forEachThingHit(this.player.sprite.x+this.player.getFacing()*this.weaponReach,this.player.sprite.y,this.hitbox,this.player,this.handleHitCallback)};SwordWeaponSlot.prototype.stopAttack=function(){};function BowWeaponSlot(player){this.sprite=new PIXI.Sprite;this.sprite.anchor.set(6.5/8,4/8);this.player=player;this.attackCooldown=0;this.textureName=null;this.setTexture("bow1")}BowWeaponSlot.prototype.update=function(dt){if(this.attackCooldown<=0){this.sprite.rotation=Math.PI/5+Math.PI/40*Math.cos(10*this.player.frame);this.sprite.x=3;this.sprite.y=-2.5}else{this.sprite.rotation=0;this.sprite.x=3;this.sprite.y=-3.25;this.attackCooldown-=dt}};BowWeaponSlot.prototype.setTexture=function(name){if(this.textureName!==name){this.sprite.texture=Utils.getFrame(RES.WEAPONS,name);this.textureName=name}};BowWeaponSlot.prototype.startAttack=function(){if(this.player.numArrows<=0)return;if(this.attackCooldown>0)return;Audio.playSound(RES.ATTACK_SWORD_SND);this.attackCooldown=.2;this.player.numArrows--;var arrow=new Arrow(this.player,this.player.sprite.x,this.player.sprite.y+this.sprite.y,this.player.getFacing()*100,0,Math.abs(this.sprite.y));this.player.level.addThing(arrow)};BowWeaponSlot.prototype.stopAttack=function(){};function Arrow(owner,x,y,velx,vely,height){this.owner=owner;this.sprite=new PIXI.Sprite(Utils.getFrame(RES.WEAPONS,"arrow"));this.sprite.anchor.set(.5,.5);this.sprite.scale.x=Math.sign(velx);this.sprite.scale.y=1;this.sprite.x=x;this.sprite.y=y;this.velx=velx;this.vely=vely;this.height=height;this.state=ARROW_FLIGHT;this.timer=0;this.hitbox=new Thing.Hitbox(0,0,5,5)}Arrow.prototype.update=function(dt){var level=this.owner.level;if(this.state===ARROW_FLIGHT){this.sprite.x+=this.velx*dt;this.sprite.y+=this.vely*dt;if(this.sprite.x<level.camera.x||this.sprite.x>level.camera.x+level.camera.width){level.removeThing(this)}var tile=level.bg.getTileAt(this.sprite.x+Math.sign(this.velx)*4,this.sprite.y+this.height);if(tile.solid){this.velx*=-.25;this.vely=0;this.state=ARROW_FALLING;Audio.playSound(RES.ARROW_DING_SND,.4);return}var other=level.checkHit(this.sprite.x,this.sprite.y,this.hitbox,this.owner);if(other&&other.handleHit){var ret=other.handleHit(this.sprite.x,this.sprite.y,1);if(ret===true){level.removeThing(this)}}}else if(this.state===ARROW_FALLING){this.vely-=700*dt;this.height+=this.vely*dt;this.sprite.x+=this.velx*dt;this.sprite.y-=this.vely*dt;if(this.height<=0){this.timer=1;this.state=ARROW_DISAPPEAR}}else{this.timer-=dt;if(this.timer<=0)level.removeThing(this)}};module.exports={Bow:BowWeaponSlot,Sword:SwordWeaponSlot}},{"./audio":2,"./res":23,"./thing":27,"./utils":31}]},{},[18])(18)});
